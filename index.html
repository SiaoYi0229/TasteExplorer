<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <!-- ç¶²é æ¨™ç±¤åœ–ç¤º -->
<link rel="icon" href="favicon.png" type="image/png">
<!-- æ‰‹æ©ŸåŠ å…¥ä¸»ç•«é¢æ™‚çš„åœ–ç¤º (iOS) -->
<link rel="apple-touch-icon" href="favicon.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>TasteExplorer - ç¾å‘³æ¢ç´¢</title>
   <style>
/* --- 1. æ ¸å¿ƒæ¨£å¼ï¼š100% é…è‰²èˆ‡å¯¬åº¦ --- */
:root {
    --primary-orange: #FF6600;
    --glass-bg: rgba(25, 25, 25, 0.85);
    --glass-border: rgba(255, 255, 255, 0.15);
    --input-bg: rgba(255, 255, 255, 0.1);
    --text-color: #ffffff;
    --label-color: #cccccc;
    --accent-yellow: #FFCC00;
}

html, body { 
    overscroll-behavior-y: none; 
    height: 100%; 
    overflow: hidden; 
    position: fixed; 
    width: 100%; 
    margin: 0; 
    padding: 0; 
    background-color: #000; 
}
html { font-size: 14px; } 
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, "SF Pro Text", "Helvetica Neue", sans-serif; }
body { color: #fff; display: flex; align-items: center; justify-content: center; }

#bg-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; }
.bg-slide { position: absolute; width: 100%; height: 100%; background-size: cover; background-position: center; opacity: 0; transition: opacity 1s; }
.bg-slide.active { opacity: 0.6; }

/* --- 2. API è¨­å®šè¦–çª— --- */
#api-overlay { 
    position: fixed; 
    top: 0; left: 0; width: 100vw; height: 100vh; 
    background: rgba(0,0,0,0.7); 
    backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); 
    z-index: 9999; display: none; 
    flex-direction: column; align-items: center; justify-content: center; 
}
.api-card { width: 90%; max-width: 340px; background: rgba(20, 20, 20, 0.9); border: 1px solid var(--glass-border); border-radius: 24px; padding: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); text-align: center; }

/* --- 3. ä½ˆå±€æ ¸å¿ƒï¼šå¼·åˆ¶çš„é ‚ã€ä¸­ã€åº•ä¸‰æ®µåˆ†çµ„ --- */
.container { 
    width: 95%; 
    max-width: 357px; 
    height: 100dvh; 
    z-index: 10; 
    display: flex; 
    flex-direction: column; 
    justify-content: space-between; /* åªæœ‰é€™ä¸‰å¤§å¡Šæœƒè¢«æ‹‰é–‹ */
    align-items: center; 
    padding: 40px 0 50px 0; 
    position: relative; 
}
.container.blur-mode { filter: blur(15px) brightness(0.4); transform: scale(0.95); pointer-events: none; }

/* Group 1: é ‚éƒ¨æ¨™é¡Œçµ„ (Logo + Tagline + Location) */
.header { 
    width: 100%; 
    flex: 0 0 auto; /* ç¦æ­¢é€™æ•´çµ„åœ¨è¢å¹•å¤§æ™‚è¢«è‡ªå‹•æ‹‰é•· */
    display: flex; 
    flex-direction: column; 
    align-items: center; 
    position: relative; 
}

/* Logo ç„¡é‚Šè· */
.logo { font-size: 2.77rem; font-weight: 800; color: var(--primary-orange); line-height: 1.1; letter-spacing: -1px; margin: 0; }

/* æ¨™èªï¼šåš´æ ¼å›ºå®š 6px */
.tagline { font-size: 1.2rem; color: #ffffff; opacity: 0.8; margin-top: 6px; margin-bottom: 0; }

/* åº§æ¨™ï¼šåš´æ ¼å›ºå®š 6px (èˆ‡æ¨™èªç­‰è·) */
.location-status {
    font-size: 0.68rem; 
    color: var(--accent-yellow);
    background: rgba(0,0,0,0.2);
    padding: 2px 10px;
    border-radius: 20px;
    margin-top: 6px; 
    display: flex;
    align-items: center;
    gap: 4px;
    border: 1px solid rgba(255, 204, 0, 0.2);
}
.location-dot { width: 6px; height: 6px; background: #2ecc71; border-radius: 50%; animation: pulse 2s infinite; }
@keyframes pulse { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 6px rgba(46, 204, 113, 0); } 100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(46, 204, 113, 0); } }

/* âš™ï¸ è¨­å®šæŒ‰éˆ•ï¼šå°é½Šæ¨™é¡Œæœ€å³é‚Š (ä¹Ÿå°±æ˜¯å¡ç‰‡çš„æœ€å³å´é‚Šç·£) */
.settings-btn { 
    position: absolute; 
    top: 0;
    right: 0px; 
    height: 3rem; /* é…åˆ Logo é«˜åº¦ */
    display: flex;
    align-items: center;
    font-size: 24px; 
    cursor: pointer; 
    z-index: 50; 
}

/* Group 2: ä¸­é–“é¸é …çµ„ (ç»ç’ƒå¡ç‰‡) */
.glass-card { 
    width: 100%; 
    background: rgba(20, 20, 20, 0.75); 
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); 
    border-radius: 20px; padding: 18px; 
    border: 1px solid var(--glass-border); 
    flex: 0 0 auto; 
}

/* Group 3: åº•éƒ¨çµ„ (æŒ‰éˆ•èˆ‡æç¤º) */
.footer-action { 
    width: 100%; 
    flex: 0 0 auto; 
    display: flex; 
    flex-direction: column; 
    align-items: center; 
}

/* --- è¡¨å–®ç´°ç¯€èˆ‡åŠŸèƒ½æ¨£å¼ (ç¶­æŒæœ€åŸå§‹è¨­å®š) --- */
.form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.full-width { grid-column: span 2; }
label { font-size: 0.75rem; color: #ffffff; margin-bottom: 4px; display: block; font-weight: 600; }
.input-box { background: var(--input-bg); border-radius: 10px; height: 38px; display: flex; align-items: center; padding: 0 10px; border: 1px solid transparent; }
.input-box:focus-within { border-color: var(--primary-orange); }
select { background: transparent; border: none; color: white; width: 100%; outline: none; font-size: 0.85rem; appearance: none; -webkit-appearance: none; cursor: pointer; }
.toggle-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 4px; }
.toggle-btn { background: var(--input-bg); height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 0.85rem; }
.toggle-btn.selected { background: rgba(255,102,0,0.2); border-color: var(--primary-orange); color: var(--primary-orange); font-weight: bold; }
#btn-open.selected { background: rgba(46,204,113,0.15); border-color: #2ecc71; color: #2ecc71; }
.cta-button { width: 100%; background: linear-gradient(180deg, #FF8533, #FF6600); border: none; padding: 16px; font-weight: 700; border-radius: 16px; color: #fff; cursor: pointer; font-size: 1.1rem; box-shadow: 0 4px 15px rgba(255, 102, 0, 0.4); }
.usage-hint { font-size: 0.85rem; margin-top: 10px; opacity: 0.7; color: #ffffff; font-weight: 500; }

/* --- æ¢ç´¢ä»‹é¢èˆ‡å¡ç‰‡ (å«è·é›¢åŠŸèƒ½æ¨£å¼) --- */
#swiper-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; display: none; flex-direction: column; align-items: center; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); }
.card-stack { width: 100%; max-width: 340px; height: 100%; display: flex; flex-direction: column; align-items: center; overflow-y: auto; overflow-x: hidden; padding: 20px 0 120px 0; gap: 20px; }
.swipe-card-wrapper { width: 92%; flex-shrink: 0; transition: transform 0.4s ease, opacity 0.4s ease; position: relative; }
.swipe-card { width: 100%; background: var(--glass-bg); border-radius: 24px; border: 1px solid var(--glass-border); padding: 20px; display: flex; flex-direction: column; gap: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
.card-badge { padding: 3px 10px; border-radius: 6px; font-size: 0.75rem; font-weight: bold; }
.badge-rating { background: var(--accent-yellow); color: #000; }
.badge-price { background: rgba(255,255,255,0.1); color: #eee; }
.badge-distance { background: var(--primary-orange); color: #fff; }
.card-map-btn { background: var(--primary-orange); color: #fff; text-decoration: none; padding: 12px; border-radius: 14px; text-align: center; font-weight: bold; margin-top: 10px; font-size: 0.95rem; }
.close-swiper { position: fixed; bottom: 40px; background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 12px 30px; border-radius: 50px; cursor: pointer; z-index: 120; font-weight: bold; backdrop-filter: blur(10px); }
#loader { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 9999; flex-direction: column; align-items: center; justify-content: center; }
.spinner { width: 50px; height: 50px; border: 5px solid rgba(255,102,0,0.1); border-top-color: var(--primary-orange); border-radius: 50%; animation: spin 1s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body touch-action="none">
    <div id="api-overlay"><div class="api-card"><h2>ğŸ”‘ API è¨­å®š</h2><p>è«‹è¼¸å…¥æ‚¨çš„ Gemini API Keyã€‚<br>è¨­å®šå¾Œäº«æœ‰ç¨ç«‹çš„æ¯æ—¥ 15 æ¬¡é…é¡ã€‚</p><input type="password" id="api-key-input" class="api-input" placeholder="è²¼ä¸Šæ‚¨çš„ API Key (AIza...)"><button class="api-save-btn" onclick="saveApiKey()">ç¢ºèªä¸¦å„²å­˜</button><a href="https://aistudio.google.com/app/apikey" target="_blank" style="color:var(--accent-yellow); font-size:0.85rem; display:block; margin-top:15px;">ğŸ‘‰ é»æ­¤ç”³è«‹æ‚¨çš„ API Key</a><button onclick="document.getElementById('api-overlay').style.display='none'" style="background:none; border:none; color:#777; margin-top:20px;">è¿”å›é¦–é </button></div></div>
    <div id="bg-container"></div>
    <div class="container" id="main-ui">
        <div class="header"><div class="logo">TasteExplorer</div><div class="settings-btn" onclick="document.getElementById('api-overlay').style.display='flex'">âš™ï¸</div><div class="tagline">æ¢ç´¢éš±è—ç¾å‘³ äº«å—æ¥µè‡´é¥—å®´</div></div>
<div id="location-display" class="location-status">
    <div class="location-dot"></div>
    <span id="coords-text">æ­£åœ¨å–å¾— GPS åº§æ¨™...</span>
</div>
        <div class="glass-card">
            <div class="form-grid">
                <div class="form-group"><label>ğŸ“ ç¸£å¸‚</label><div class="input-box"><select id="city" onchange="updateDistricts(); checkTransAvailability();">
                    <optgroup label="åŒ—éƒ¨åœ°å€"><option value="Taipei" selected>å°åŒ—å¸‚</option><option value="NewTaipei">æ–°åŒ—å¸‚</option><option value="Keelung">åŸºéš†å¸‚</option><option value="Taoyuan">æ¡ƒåœ’å¸‚</option><option value="HsinchuCity">æ–°ç«¹å¸‚</option><option value="HsinchuCounty">æ–°ç«¹ç¸£</option><option value="Yilan">å®œè˜­ç¸£</option></optgroup>
                    <optgroup label="ä¸­éƒ¨åœ°å€"><option value="Miaoli">è‹—æ —ç¸£</option><option value="Taichung">å°ä¸­å¸‚</option><option value="Changhua">å½°åŒ–ç¸£</option><option value="Nantou">å—æŠ•ç¸£</option><option value="Yunlin">é›²æ—ç¸£</option></optgroup>
                    <optgroup label="å—éƒ¨åœ°å€"><option value="ChiayiCity">å˜‰ç¾©å¸‚</option><option value="ChiayiCounty">å˜‰ç¾©ç¸£</option><option value="Tainan">å°å—å¸‚</option><option value="Kaohsiung">é«˜é›„å¸‚</option><option value="Pingtung">å±æ±ç¸£</option></optgroup>
                    <optgroup label="æ±éƒ¨èˆ‡é›¢å³¶"><option value="Hualien">èŠ±è“®ç¸£</option><option value="Taitung">å°æ±ç¸£</option><option value="Penghu">æ¾æ¹–ç¸£</option><option value="Kinmen">é‡‘é–€ç¸£</option><option value="Lienchiang">é€£æ±Ÿç¸£</option></optgroup>
                </select></div></div>
                <div class="form-group"><label>ğŸ™ï¸ è¡Œæ”¿å€</label><div class="input-box"><select id="district" onchange="checkTransAvailability();"><option>å…¨å€</option></select></div></div>
                <div class="form-group full-width"><label>ğŸš† äº¤é€šåå¥½</label><div class="input-box"><select id="transport" onchange="checkTransAvailability()"><option value="none" selected>ğŸ¤·â€â™‚ï¸ ä¸æ‹˜</option><option value="mrt">ğŸš‡ é„°è¿‘æ·é‹ç«™ (æ­¥è¡Œå¯é”)</option><option value="hsr">ğŸš„ é„°è¿‘é«˜éµç«™ (æ­¥è¡Œå¯é”)</option><option value="train">ğŸš‚ é„°è¿‘ç«è»Šç«™ (æ­¥è¡Œå¯é”)</option><option value="airport">âœˆï¸ é„°è¿‘æ©Ÿå ´ (æ­¥è¡Œå¯é”)</option></select></div></div>
                <div class="form-group full-width" id="mrt-section" style="display:none;"><label id="trans-label">ğŸš‰ æŒ‡å®šç«™é»</label><div class="input-box"><select id="mrt-station"></select></div></div>
                <div class="form-group full-width"><label>ğŸ¤¤ æƒ³åƒä»€éº¼ï¼Ÿ</label><div class="input-box"><select id="food">
                    <option value="all">å…¨éƒ¨ (ä»€éº¼éƒ½æƒ³åƒ)</option>
                    <optgroup label="ğŸ”¥ ç†±é–€ç²¾é¸"><option value="hotpot">ç«é‹ / éº»è¾£é‹ / æ¶®æ¶®é‹</option><option value="bbq">ç‡’è‚‰ / æ—¥å¼çƒ¤è‚‰ / éŸ“å¼çƒ¤è‚‰</option><option value="steak">ç‰›æ’ / éµæ¿ç‡’</option><option value="buffet">åƒåˆ°é£½ (Buffet)</option></optgroup>
                    <optgroup label="ğŸœ å°å¼èˆ‡ä¸­å¼"><option value="taiwanese_snack">å°ç£å°åƒ / è·¯é‚Šæ”¤</option><option value="beef_noodle">ç‰›è‚‰éºµ</option><option value="rechao">æµ·é®®ç†±ç‚’ / åˆèœ</option><option value="hot_soup">æ»·å‘³ / é¹½é…¥é› / å®µå¤œ</option></optgroup>
                    <optgroup label="ğŸ£ æ—¥å¼æ–™ç†"><option value="ramen">æ—¥å¼æ‹‰éºµ / çƒé¾éºµ</option><option value="sushi">å£½å¸ / ç”Ÿé­šç‰‡ / ä¸¼é£¯</option><option value="izakaya">å±…é…’å±‹ / ä¸²ç‡’</option><option value="curry">æ—¥å¼å’–å“© / å®šé£Ÿ</option></optgroup>
                    <optgroup label="ğŸŒ ç•°åœ‹é¢¨å‘³"><option value="korean">éŸ“å¼æ–™ç† / ç‚¸é›</option><option value="thai_viet">æ³°å¼ / è¶Šå¼æ–™ç†</option><option value="american">ç¾å¼æ¼¢å ¡ / ç‚¸ç‰©</option><option value="italian">ç¾©å¼æ–™ç† / æŠ«è–© / ç¾©å¤§åˆ©éºµ</option></optgroup>
                    <optgroup label="â˜• æ”¾é¬†æ™‚åˆ»"><option value="brunch">æ—©åˆé¤ (Brunch)</option><option value="cafe">å’–å•¡å»³ / ä¸‹åˆèŒ¶ / ç”œé»</option><option value="bistro">é¤é…’é¤¨ / Bar</option></optgroup>
                    <optgroup label="ğŸ¥¬ å…¶ä»–"><option value="vegetarian">ç´ é£Ÿ / è”¬é£Ÿ</option><option value="healthy">å¥åº·é¤ç›’ / è¼•é£Ÿ</option></optgroup>
                </select></div></div>
                <div class="form-group full-width"><label>ğŸ‘¥ äººæ•¸</label><div class="input-box"><select id="people"><option selected>1~2 äºº</option><option>2~4 äºº</option><option>4~6 äºº</option><option>6 äººä»¥ä¸Š</option></select></div></div>
                <div class="form-group full-width"><label>ğŸ¯ ç”¨é¤ç›®çš„</label><div class="input-box"><select id="purpose"><option>ğŸ¤·â€â™‚ï¸ ä¸æ‹˜ (éš¨æ„åƒåƒ)</option><option>ğŸ‘¯ æœ‹å‹èšé¤ (ç†±é¬§)</option><option>ğŸ’‘ æƒ…ä¾¶ç´„æœƒ (æ°£æ°›)</option><option>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å®¶åº­èšæœƒ (é•·è¼©/å°å­©)</option><option>ğŸ§˜ ä¸€äººç¨äº« (å®‰éœ)</option><option>ğŸ’¼ å•†å‹™å®´è«‹ (æ­£å¼)</option><option>ğŸŒ™ å®µå¤œå ´ (æ·±å¤œ)</option><option>ğŸ“¸ IGæ‰“å¡/ç¶²ç¾åº—</option><option>âš¡ å¿«é€Ÿè§£æ±º (è¶•æ™‚é–“)</option><option>ğŸ‰ æ…¶ç”Ÿ/ç´€å¿µæ—¥</option></select></div></div>
                <div class="form-group full-width"><label>ğŸ’° é ç®—ç¯„åœ</label><div class="input-box"><select id="budget"><option value="low">ğŸ’µ å¹³åƒ¹ (&lt;$300)</option><option value="mid">ğŸ’µğŸ’µ ä¸­åƒ¹ä½ ($300ï½$800)</option><option value="high">ğŸ’µğŸ’µğŸ’µ é«˜ç´š (&gt;$800)</option><option value="luxury">ğŸ’ é ‚ç´šå¥¢è¯ (&gt;$2000)</option></select></div></div>
                <div class="form-group full-width"><div class="toggle-row"><div id="btn-hidden" class="toggle-btn" onclick="this.classList.toggle('selected')">ğŸ¤« éš±è—ç‰ˆ</div><div id="btn-open" class="toggle-btn" onclick="this.classList.toggle('selected')">ğŸ•’ ç‡Ÿæ¥­ä¸­</div></div></div>
            </div>
        </div>
        <div class="footer-action"><button id="search-btn" class="cta-button" onclick="handleSearchClick()">é–‹å§‹æ¢ç´¢ç¾é£Ÿ</button><div id="usage-text" class="usage-hint">ä»Šæ—¥å‰©é¤˜æ¬¡æ•¸ï¼š-- æ¬¡</div></div>
    </div>
    <div id="loader"><div class="spinner"></div><p style="color: white; margin-top: 10px; font-weight: bold;">æ­£åœ¨ç©¿æ¢­å··å¼„ä¸­...</p></div>
    <div id="swiper-overlay"><div id="round-info"></div><div class="card-stack" id="card-stack"></div><button class="close-swiper" onclick="resetUI()">â† è¿”å›èª¿æ•´</button></div>
    <script>
        // å…¨åŸŸè®Šæ•¸å„²å­˜ä½¿ç”¨è€…ä½ç½®
let userCoords = { lat: null, lng: null };

// ç¢ºä¿ calculateDistance é‚è¼¯ç²¾ç¢º (ç›´ç·šè·é›¢)
function calculateDistance(lat1, lon1, lat2, lon2) {
    if (!lat1 || !lon1 || !lat2 || !lon2) return "è¨ˆç®—ä¸­...";
    const R = 6371; 
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLon / 2) * Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    const distance = R * c;
    return distance < 1 ? `${(distance * 1000).toFixed(0)}m` : `${distance.toFixed(1)}km`;
}

// å•Ÿå‹• GPS ç›£æ¸¬
function initLocationWatch() {
    if ("geolocation" in navigator) {
        navigator.geolocation.watchPosition(
            (pos) => {
                userCoords.lat = pos.coords.latitude;
                userCoords.lng = pos.coords.longitude;
                document.getElementById('coords-text').innerText = 
                    `ğŸ“ ${userCoords.lat.toFixed(4)}, ${userCoords.lng.toFixed(4)} (å·²åŒæ­¥)`;
            },
            (err) => {
                document.getElementById('coords-text').innerText = "âŒ ç„¡æ³•å–å¾—åº§æ¨™ (è«‹é–‹å•Ÿå®šä½)";
            },
            { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
        );
    } else {
        document.getElementById('coords-text').innerText = "âŒ ç€è¦½å™¨ä¸æ”¯æ´å®šä½";
    }
}
// é é¢è¼‰å…¥å¾Œå•Ÿå‹•
initLocationWatch();
    /* --- 1. æ ¸å¿ƒæ•¸æ“š 100% ç§»æ¤ --- */
    const DAILY_LIMIT = 15;
    const images = ['https://images.unsplash.com/photo-1555939594-58d7cb561ad1', 'https://images.unsplash.com/photo-1594046243098-0fceea9d451e', 'https://images.unsplash.com/photo-1563245372-f21724e3856d', 'https://images.unsplash.com/photo-1512621776951-a57141f2eefd', 'https://images.unsplash.com/photo-1504674900247-0877df9cc836', 'https://images.unsplash.com/photo-1565299624946-b28f40a0ae38'];
    /* --- 2. äº¤é€šèˆ‡ç¸£å¸‚æ•¸æ“šåº« --- */
    const cityData = { 'Taipei': ['å…¨å€', 'ä¸­æ­£å€', 'å¤§åŒå€', 'ä¸­å±±å€', 'æ¾å±±å€', 'å¤§å®‰å€', 'è¬è¯å€', 'ä¿¡ç¾©å€', 'å£«æ—å€', 'åŒ—æŠ•å€', 'å…§æ¹–å€', 'å—æ¸¯å€', 'æ–‡å±±å€'], 'NewTaipei': ['å…¨å€', 'æ¿æ©‹å€', 'ä¸‰é‡å€', 'ä¸­å’Œå€', 'æ°¸å’Œå€', 'æ–°èŠå€', 'æ–°åº—å€', 'åœŸåŸå€', 'è˜†æ´²å€', 'æ¨¹æ—å€', 'é¶¯æ­Œå€', 'ä¸‰å³½å€', 'æ·¡æ°´å€', 'æ±æ­¢å€', 'ç‘èŠ³å€', 'äº”è‚¡å€', 'æ³°å±±å€', 'æ—å£å€', 'æ·±å‘å€', 'çŸ³ç¢‡å€', 'åªæ—å€', 'ä¸‰èŠå€', 'çŸ³é–€å€', 'å…«é‡Œå€', 'å¹³æºªå€', 'é›™æºªå€', 'è²¢å¯®å€', 'é‡‘å±±å€', 'è¬é‡Œå€', 'çƒä¾†å€'], 'Keelung': ['å…¨å€', 'ä»æ„›å€', 'ä¿¡ç¾©å€', 'ä¸­æ­£å€', 'ä¸­å±±å€', 'å®‰æ¨‚å€', 'æš–æš–å€', 'ä¸ƒå µå€'], 'Taoyuan': ['å…¨å€', 'æ¡ƒåœ’å€', 'ä¸­å£¢å€', 'å¹³é®å€', 'å…«å¾·å€', 'æ¥Šæ¢…å€', 'è˜†ç«¹å€', 'å¤§æºªå€', 'é¾æ½­å€', 'é¾œå±±å€', 'å¤§åœ’å€', 'è§€éŸ³å€', 'æ–°å±‹å€', 'å¾©èˆˆå€'], 'HsinchuCity': ['å…¨å€', 'æ±å€', 'åŒ—å€', 'é¦™å±±å€'], 'HsinchuCounty': ['å…¨å€', 'ç«¹åŒ—å¸‚', 'ç«¹æ±é®', 'æ–°åŸ”é®', 'é—œè¥¿é®', 'æ¹–å£é„‰', 'æ–°è±é„‰', 'å³¨çœ‰é„‰', 'å¯¶å±±é„‰', 'åŒ—åŸ”é„‰', 'æ©«å±±é„‰', 'èŠæ—é„‰', 'å°–çŸ³é„‰', 'äº”å³°é„‰'], 'Yilan': ['å…¨å€', 'å®œè˜­å¸‚', 'ç¾…æ±é®', 'è˜‡æ¾³é®', 'é ­åŸé®', 'ç¤æºªé„‰', 'å£¯åœé„‰', 'å“¡å±±é„‰', 'å†¬å±±é„‰', 'äº”çµé„‰', 'ä¸‰æ˜Ÿé„‰', 'å¤§åŒé„‰', 'å—æ¾³é„‰'], 'Miaoli': ['å…¨å€', 'è‹—æ —å¸‚', 'é ­ä»½å¸‚', 'ç«¹å—é®', 'å¾Œé¾é®', 'é€šéœ„é®', 'è‹‘è£¡é®', 'å“è˜­é®', 'é€ æ©‹é„‰', 'è¥¿æ¹–é„‰', 'é ­å±‹é„‰', 'å…¬é¤¨é„‰', 'éŠ…é‘¼é„‰', 'ä¸‰ç¾©é„‰', 'å¤§æ¹–é„‰', 'ç…æ½­é„‰', 'ä¸‰ç£é„‰', 'å—åº„é„‰', 'æ³°å®‰é„‰'], 'Taichung': ['å…¨å€', 'ä¸­å€', 'æ±å€', 'å—å€', 'è¥¿å€', 'åŒ—å€', 'åŒ—å±¯å€', 'è¥¿å±¯å€', 'å—å±¯å€', 'å¤ªå¹³å€', 'å¤§é‡Œå€', 'éœ§å³°å€', 'çƒæ—¥å€', 'è±åŸå€', 'å¾Œé‡Œå€', 'çŸ³å²¡å€', 'æ±å‹¢å€', 'å’Œå¹³å€', 'æ–°ç¤¾å€', 'æ½­å­å€', 'å¤§é›…å€', 'ç¥å²¡å€', 'å¤§è‚šå€', 'é¾äº•å€', 'æ¢§æ£²å€', 'æ¸…æ°´å€', 'å¤§ç”²å€', 'å¤–åŸ”å€', 'å¤§å®‰å€'], 'Changhua': ['å…¨å€', 'å½°åŒ–å¸‚', 'å“¡æ—å¸‚', 'å’Œç¾é®', 'é¹¿æ¸¯é®', 'æºªæ¹–é®', 'äºŒæ—é®', 'ç”°ä¸­é®', 'åŒ—æ–—é®', 'èŠ±å£‡é„‰', 'èŠ¬åœ’é„‰', 'å¤§æ‘é„‰', 'æ°¸é–é„‰', 'ä¼¸æ¸¯é„‰', 'ç·šè¥¿é„‰', 'ç¦èˆˆé„‰', 'ç§€æ°´é„‰', 'åŸ”å¿ƒé„‰', 'åŸ”é¹½é„‰', 'å¤§åŸé„‰', 'èŠ³è‹‘é„‰', 'ç«¹å¡˜é„‰', 'ç¤¾é ­é„‰', 'äºŒæ°´é„‰', 'æºªå·é„‰', 'ç”°å°¾é„‰', 'åŸ¤é ­é„‰'], 'Nantou': ['å…¨å€', 'å—æŠ•å¸‚', 'åŸ”é‡Œé®', 'è‰å±¯é®', 'ç«¹å±±é®', 'é›†é›†é®', 'åé–“é„‰', 'é¹¿è°·é„‰', 'ä¸­å¯®é„‰', 'é­šæ± é„‰', 'åœ‹å§“é„‰', 'æ°´é‡Œé„‰', 'ä¿¡ç¾©é„‰', 'ä»æ„›é„‰'], 'Yunlin': ['å…¨å€', 'æ–—å…­å¸‚', 'æ–—å—é®', 'è™å°¾é®', 'è¥¿èºé®', 'åœŸåº«é®', 'åŒ—æ¸¯é®', 'å¤å‘é„‰', 'å¤§åŸ¤é„‰', 'è¿æ¡é„‰', 'æ—å…§é„‰', 'äºŒå´™é„‰', 'å´™èƒŒé„‰', 'éº¥å¯®é„‰', 'æ±å‹¢é„‰', 'è¤’å¿ é„‰', 'å°è¥¿é„‰', 'å…ƒé•·é„‰', 'å››æ¹–é„‰', 'å£æ¹–é„‰', 'æ°´æ—é„‰'], 'ChiayiCity': ['å…¨å€', 'æ±å€', 'è¥¿å€'], 'ChiayiCounty': ['å…¨å€', 'å¤ªä¿å¸‚', 'æœ´å­å¸‚', 'å¸ƒè¢‹é®', 'å¤§æ—é®', 'æ°‘é›„é„‰', 'æºªå£é„‰', 'æ–°æ¸¯é„‰', 'å…­è…³é„‰', 'æ±çŸ³é„‰', 'ç¾©ç«¹é„‰', 'é¹¿è‰é„‰', 'æ°´ä¸Šé„‰', 'ä¸­åŸ”é„‰', 'ç«¹å´é„‰', 'æ¢…å±±é„‰', 'ç•ªè·¯é„‰', 'å¤§åŸ”é„‰', 'é˜¿é‡Œå±±é„‰'], 'Tainan': ['å…¨å€', 'ä¸­è¥¿å€', 'æ±å€', 'å—å€', 'åŒ—å€', 'å®‰å¹³å€', 'å®‰å—å€', 'æ°¸åº·å€', 'æ­¸ä»å€', 'æ–°åŒ–å€', 'ç‰äº•å€', 'ä»å¾·å€', 'é—œå»Ÿå€', 'å®˜ç”°å€', 'éº»è±†å€', 'ä½³é‡Œå€', 'æ–°ç‡Ÿå€', 'å–„åŒ–å€'], 'Kaohsiung': ['å…¨å€', 'æ¥ æ¢“å€', 'å·¦ç‡Ÿå€', 'é¼“å±±å€', 'ä¸‰æ°‘å€', 'é¹½åŸ•å€', 'å‰é‡‘å€', 'æ–°èˆˆå€', 'è‹“é›…å€', 'å‰é®å€', 'æ——æ´¥å€', 'å°æ¸¯å€', 'é³³å±±å€', 'å¤§å¯®å€', 'é³¥æ¾å€', 'æ—åœ’å€', 'ä»æ­¦å€', 'å¤§æ¨¹å€', 'å¤§ç¤¾å€', 'å²¡å±±å€', 'è·¯ç«¹å€', 'æ——å±±å€', 'ç¾æ¿ƒå€'], 'Pingtung': ['å…¨å€', 'å±æ±å¸‚', 'æ½®å·é®', 'æ±æ¸¯é®', 'æ†æ˜¥é®', 'è¬ä¸¹é„‰', 'é•·æ²»é„‰', 'é‡Œæ¸¯é„‰', 'å…§åŸ”é„‰', 'æ‹å¯®é„‰', 'è»ŠåŸé„‰'], 'Hualien': ['å…¨å€', 'èŠ±è“®å¸‚', 'é³³æ—é®', 'ç‰é‡Œé®', 'æ–°åŸé„‰', 'å‰å®‰é„‰', 'å£½è±é„‰', 'å…‰å¾©é„‰', 'ç‘ç©—é„‰'], 'Taitung': ['å…¨å€', 'å°æ±å¸‚', 'æˆåŠŸé®', 'é—œå±±é®', 'å‘å—é„‰', 'é¹¿é‡é„‰', 'æ± ä¸Šé„‰', 'ç¶ å³¶é„‰', 'è˜­å¶¼é„‰'], 'Penghu': ['å…¨å€', 'é¦¬å…¬å¸‚', 'æ¹–è¥¿é„‰', 'ç™½æ²™é„‰', 'è¥¿å¶¼é„‰'], 'Kinmen': ['å…¨å€', 'é‡‘åŸé®', 'é‡‘æ¹–é®', 'é‡‘æ²™é®', 'é‡‘å¯§é„‰'], 'Lienchiang': ['å…¨å€', 'å—ç«¿é„‰', 'åŒ—ç«¿é„‰', 'è’å…‰é„‰', 'æ±å¼•é„‰'] };
    const mrtLinesTaipei = { 'æ¿å—ç·š (BL)': ['é¾å±±å¯º', 'è¥¿é–€', 'å°åŒ—è»Šç«™', 'å–„å°å¯º', 'å¿ å­æ–°ç”Ÿ', 'å¿ å­å¾©èˆˆ', 'å¿ å­æ•¦åŒ–', 'åœ‹çˆ¶ç´€å¿µé¤¨', 'å¸‚æ”¿åºœ', 'æ°¸æ˜¥', 'å¾Œå±±åŸ¤', 'æ˜†é™½', 'å—æ¸¯', 'å—æ¸¯å±•è¦½é¤¨'], 'æ·¡æ°´ä¿¡ç¾©ç·š (R)': ['è±¡å±±', 'å°åŒ—101/ä¸–è²¿', 'ä¿¡ç¾©å®‰å’Œ', 'å¤§å®‰', 'å¤§å®‰æ£®æ—å…¬åœ’', 'æ±é–€', 'ä¸­æ­£ç´€å¿µå ‚', 'å°å¤§é†«é™¢', 'å°åŒ—è»Šç«™', 'ä¸­å±±', 'é›™é€£', 'æ°‘æ¬Šè¥¿è·¯', 'åœ“å±±', 'åŠæ½­', 'å£«æ—', 'èŠå±±', 'æ˜å¾·', 'çŸ³ç‰Œ', 'å”­å“©å²¸', 'å¥‡å²©', 'åŒ—æŠ•', 'æ–°åŒ—æŠ•', 'å¾©èˆˆå´—', 'å¿ ç¾©', 'é—œæ¸¡', 'ç«¹åœ', 'ç´…æ¨¹æ—', 'æ·¡æ°´'], 'æ¾å±±æ–°åº—ç·š (G)': ['æ™¯ç¾', 'è¬éš†', 'å…¬é¤¨', 'å°é›»å¤§æ¨“', 'å¤äº­', 'ä¸­æ­£ç´€å¿µå ‚', 'å°å—é–€', 'è¥¿é–€', 'åŒ—é–€', 'ä¸­å±±', 'æ¾æ±Ÿå—äº¬', 'å—äº¬å¾©èˆˆ', 'å°åŒ—å°å·¨è›‹', 'å—äº¬ä¸‰æ°‘', 'æ¾å±±'], 'ä¸­å’Œæ–°è˜†ç·š (O)': ['å¤äº­', 'æ±é–€', 'å¿ å­æ–°ç”Ÿ', 'æ¾æ±Ÿå—äº¬', 'è¡Œå¤©å®®', 'ä¸­å±±åœ‹å°', 'æ°‘æ¬Šè¥¿è·¯', 'å¤§æ©‹é ­'], 'æ–‡æ¹–ç·š (BR)': ['å‹•ç‰©åœ’', 'æœ¨æŸµ', 'è¬èŠ³ç¤¾å€', 'è¬èŠ³é†«é™¢', 'è¾›äº¥', 'éºŸå…‰', 'å…­å¼µçŠ', 'ç§‘æŠ€å¤§æ¨“', 'å¤§å®‰', 'å¿ å­å¾©èˆˆ', 'å—äº¬å¾©èˆˆ', 'ä¸­å±±åœ‹ä¸­', 'æ¾å±±æ©Ÿå ´', 'å¤§ç›´', 'åŠå—è·¯', 'è¥¿æ¹–', 'æ¸¯å¢˜', 'æ–‡å¾·', 'å…§æ¹–', 'å¤§æ¹–å…¬åœ’', 'è‘«æ´²', 'æ±æ¹–', 'å—æ¸¯è»Ÿé«”åœ’å€', 'å—æ¸¯å±•è¦½é¤¨'] };
    const mrtLinesNewTaipei = { 'æ¿å—ç·š (BL)': ['é ‚åŸ”', 'æ°¸å¯§', 'åœŸåŸ', 'æµ·å±±', 'äºæ±é†«é™¢', 'åºœä¸­', 'æ¿æ©‹', 'æ–°åŸ”', 'æ±Ÿå­ç¿ '], 'æ·¡æ°´ä¿¡ç¾©ç·š (R)': ['ç«¹åœ', 'ç´…æ¨¹æ—', 'æ·¡æ°´'], 'æ¾å±±æ–°åº—ç·š (G)': ['æ–°åº—', 'æ–°åº—å€å…¬æ‰€', 'ä¸ƒå¼µ', 'å¤§åªæ—'], 'ä¸­å’Œæ–°è˜†ç·š (O)': ['å—å‹¢è§’', 'æ™¯å®‰', 'æ°¸å®‰å¸‚å ´', 'é ‚æºª', 'ä¸‰é‡åœ‹å°', 'ä¸‰å’Œåœ‹ä¸­', 'å¾åŒ¯ä¸­å­¸', 'ä¸‰æ°‘é«˜ä¸­', 'è˜†æ´²', 'å°åŒ—æ©‹', 'èœå¯®', 'ä¸‰é‡', 'å…ˆå—‡å®®', 'é ­å‰åº„', 'æ–°èŠ', 'è¼”å¤§', 'ä¸¹é³³', 'è¿´é¾'], 'ç’°ç‹€ç·š (Y)': ['å¤§åªæ—', 'åå››å¼µ', 'ç§€æœ—æ©‹', 'æ™¯å¹³', 'æ™¯å®‰', 'ä¸­å’Œ', 'æ©‹å’Œ', 'ä¸­åŸ', 'æ¿æ–°', 'æ¿æ©‹', 'æ–°åŸ”æ°‘ç”Ÿ', 'é ­å‰åº„', 'å¹¸ç¦', 'æ–°åŒ—ç”¢æ¥­åœ’å€'] };
    const mrtLinesTaoyuan = { 'æ©Ÿå ´æ·é‹ (A)': ['å°åŒ—è»Šç«™', 'ä¸‰é‡', 'æ©Ÿå ´ç¬¬ä¸€èˆªå»ˆ', 'æ©Ÿå ´ç¬¬äºŒèˆªå»ˆ', 'é«˜éµæ¡ƒåœ’ç«™', 'è€è¡—æºª'] };
    const mrtLinesTaichung = { 'ç¶ ç·š': ['åŒ—å±¯ç¸½ç«™', 'æ¾ç«¹', 'å¸‚æ”¿åºœ', 'å¤§æ…¶', 'é«˜éµå°ä¸­ç«™'] };
    const mrtLinesKaohsiung = { 'ç´…ç·š (R)': ['å°æ¸¯', 'é«˜é›„åœ‹éš›æ©Ÿå ´', 'ç¾éº—å³¶', 'å·¦ç‡Ÿ', 'å²¡å±±è»Šç«™'], 'æ©˜ç·š (O)': ['å“ˆç‘ªæ˜Ÿ', 'ç¾éº—å³¶', 'é³³å±±', 'å¤§å¯®'] };
    const hsrMap = { 'Taipei': { 'ä¸­æ­£å€': ['é«˜éµå°åŒ—ç«™'], 'å—æ¸¯å€': ['é«˜éµå—æ¸¯ç«™'] }, 'NewTaipei': { 'æ¿æ©‹å€': ['é«˜éµæ¿æ©‹ç«™'] }, 'Taoyuan': { 'ä¸­å£¢å€': ['é«˜éµæ¡ƒåœ’ç«™'] }, 'HsinchuCounty': { 'ç«¹åŒ—å¸‚': ['é«˜éµæ–°ç«¹ç«™'] }, 'Miaoli': { 'å¾Œé¾é®': ['é«˜éµè‹—æ —ç«™'] }, 'Taichung': { 'çƒæ—¥å€': ['é«˜éµå°ä¸­ç«™'] }, 'Changhua': { 'ç”°ä¸­é®': ['é«˜éµå½°åŒ–ç«™'] }, 'Yunlin': { 'è™å°¾é®': ['é«˜éµé›²æ—ç«™'] }, 'ChiayiCounty': { 'å¤ªä¿å¸‚': ['é«˜éµå˜‰ç¾©ç«™'] }, 'Tainan': { 'æ­¸ä»å€': ['é«˜éµå°å—ç«™'] }, 'Kaohsiung': { 'å·¦ç‡Ÿå€': ['é«˜éµå·¦ç‡Ÿç«™'] } };
    const trainMap = {
        'Keelung': { 'å…¨å€': ['åŸºéš†','ä¸‰å‘','å…«å µ','ä¸ƒå µ','ç™¾ç¦','æš–æš–','æµ·ç§‘é¤¨','å…«æ–—å­'] },
        'Taipei': { 'ä¸­æ­£å€': ['å°åŒ—'], 'è¬è¯å€': ['è¬è¯'], 'æ¾å±±å€': ['æ¾å±±'], 'å—æ¸¯å€': ['å—æ¸¯'] },
        'NewTaipei': { 'æ¿æ©‹å€': ['æ¿æ©‹','åºœä¸­'], 'æ±æ­¢å€': ['æ±æ­¢','æ±ç§‘','äº”å µ'], 'æ¨¹æ—å€': ['æ¨¹æ—','å—æ¨¹æ—','å±±ä½³'], 'é¶¯æ­Œå€': ['é¶¯æ­Œ'], 'ç‘èŠ³å€': ['ç‘èŠ³','çŒ´ç¡','ä¸‰è²‚å¶º'], 'é›™æºªå€': ['é›™æºª'], 'è²¢å¯®å€': ['è²¢å¯®','ç¦éš†'] },
        'Taoyuan': { 'æ¡ƒåœ’å€': ['æ¡ƒåœ’'], 'ä¸­å£¢å€': ['ä¸­å£¢','å…§å£¢'], 'æ¥Šæ¢…å€': ['æ¥Šæ¢…','åŸ”å¿ƒ','å¯Œå²¡'] },
        'HsinchuCity': { 'æ±å€': ['æ–°ç«¹','åŒ—æ–°ç«¹','åƒç”²','æ–°èŠ'] },
        'HsinchuCounty': { 'ç«¹åŒ—å¸‚': ['ç«¹åŒ—'], 'ç«¹æ±é®': ['ç«¹æ±'], 'æ¹–å£é„‰': ['æ¹–å£','æ–°è±'] },
        'Miaoli': { 'è‹—æ —å¸‚': ['è‹—æ —'], 'ç«¹å—é®': ['ç«¹å—'], 'å¾Œé¾é®': ['å¾Œé¾','è±å¯Œ'] },
        'Taichung': { 'ä¸­å€': ['å°ä¸­'], 'å—å€': ['å¤§æ…¶','äº”æ¬Š'], 'åŒ—å±¯å€': ['å¤ªåŸ','æ¾ç«¹'], 'çƒæ—¥å€': ['çƒæ—¥','æ–°çƒæ—¥'], 'è±åŸå€': ['è±åŸ'] },
        'Changhua': { 'å½°åŒ–å¸‚': ['å½°åŒ–'], 'å“¡æ—å¸‚': ['å“¡æ—'], 'ç”°ä¸­é®': ['ç”°ä¸­'], 'äºŒæ°´é„‰': ['äºŒæ°´'] },
        'Yunlin': { 'æ–—å…­å¸‚': ['æ–—å…­'], 'æ–—å—é®': ['æ–—å—'], 'æ—å…§é„‰': ['æ—å…§'] },
        'ChiayiCity': { 'è¥¿å€': ['å˜‰ç¾©'] },
        'ChiayiCounty': { 'å¤§æ—é®': ['å¤§æ—'], 'æ°‘é›„é„‰': ['æ°‘é›„'] },
        'Tainan': { 'æ±å€': ['å°å—'], 'æ°¸åº·å€': ['æ°¸åº·'], 'æ–°ç‡Ÿå€': ['æ–°ç‡Ÿ'] },
        'Kaohsiung': { 'ä¸‰æ°‘å€': ['é«˜é›„'], 'å·¦ç‡Ÿå€': ['æ–°å·¦ç‡Ÿ'], 'é³³å±±å€': ['é³³å±±'], 'å²¡å±±å€': ['å²¡å±±'], 'æ¥ æ¢“å€': ['æ¥ æ¢“'] },
        'Pingtung': { 'å±æ±å¸‚': ['å±æ±'], 'æ½®å·é®': ['æ½®å·'], 'æ‹å¯®é„‰': ['æ‹å¯®'] },
        'Yilan': { 'å®œè˜­å¸‚': ['å®œè˜­'], 'ç¾…æ±é®': ['ç¾…æ±'], 'ç¤æºªé„‰': ['ç¤æºª'] },
        'Hualien': { 'èŠ±è“®å¸‚': ['èŠ±è“®'], 'ç‰é‡Œé®': ['ç‰é‡Œ'] },
        'Taitung': { 'å°æ±å¸‚': ['å°æ±'], 'æ± ä¸Šé„‰': ['æ± ä¸Š'] }
    };
    const airportMap = { 'Taipei': { 'æ¾å±±å€': ['å°åŒ—æ¾å±±æ©Ÿå ´'] }, 'Taoyuan': { 'å¤§åœ’å€': ['æ¡ƒåœ’åœ‹éš›æ©Ÿå ´'] }, 'Taichung': { 'æ²™é¹¿å€': ['å°ä¸­åœ‹éš›æ©Ÿå ´'] }, 'Kaohsiung': { 'å°æ¸¯å€': ['é«˜é›„å°æ¸¯æ©Ÿå ´'] }, 'Penghu': { 'æ¹–è¥¿é„‰': ['æ¾æ¹–æ©Ÿå ´'] }, 'Kinmen': { 'é‡‘æ¹–é®': ['é‡‘é–€æ©Ÿå ´'] }, 'Lienchiang': { 'å—ç«¿é„‰': ['é¦¬ç¥–å—ç«¿æ©Ÿå ´'] } };
    const mrtMap = { 'Taipei': { 'ä¸­æ­£å€': ['å°åŒ—è»Šç«™', 'å–„å°å¯º', 'å¿ å­æ–°ç”Ÿ', 'ä¸­æ­£ç´€å¿µå ‚', 'å¤äº­', 'è¥¿é–€', 'å°å¤§é†«é™¢'], 'è¬è¯å€': ['è¥¿é–€', 'é¾å±±å¯º'], 'å¤§å®‰å€': ['å¿ å­å¾©èˆˆ', 'å¿ å­æ•¦åŒ–', 'åœ‹çˆ¶ç´€å¿µé¤¨', 'ä¿¡ç¾©å®‰å’Œ', 'å¤§å®‰', 'ç§‘æŠ€å¤§æ¨“', 'å…­å¼µçŠ', 'å…¬é¤¨', 'æ±é–€'], 'ä¿¡ç¾©å€': ['å¸‚æ”¿åºœ', 'æ°¸æ˜¥', 'å¾Œå±±åŸ¤', 'è±¡å±±', 'å°åŒ—101/ä¸–è²¿'], 'ä¸­å±±å€': ['ä¸­å±±', 'é›™é€£', 'æ°‘æ¬Šè¥¿è·¯', 'åœ“å±±', 'æ¾æ±Ÿå—äº¬', 'è¡Œå¤©å®®', 'ä¸­å±±åœ‹å°', 'å¤§ç›´', 'åŠå—è·¯'], 'æ¾å±±å€': ['å—äº¬å¾©èˆˆ', 'å°åŒ—å°å·¨è›‹', 'å—äº¬ä¸‰ä¸‰æ°‘', 'æ¾å±±'], 'å¤§åŒå€': ['å¤§æ©‹é ­', 'ä¸­å±±', 'åœ“å±±', 'æ°‘æ¬Šè¥¿è·¯'], 'å£«æ—å€': ['åŠæ½­', 'å£«æ—', 'èŠå±±', 'æ˜å¾·'], 'åŒ—æŠ•å€': ['çŸ³ç‰Œ', 'å”­å“©å²¸', 'å¥‡å²©', 'åŒ—æŠ•', 'æ–°åŒ—æŠ•', 'å¾©èˆˆå´—', 'é—œæ¸¡'], 'å…§æ¹–å€': ['è¥¿æ¹–', 'æ¸¯å¢˜', 'æ–‡å¾·', 'å…§æ¹–', 'å¤§æ¹–å…¬åœ’', 'è‘«æ´²', 'æ±æ¹–'], 'å—æ¸¯å€': ['å—æ¸¯', 'å—æ¸¯å±•è¦½é¤¨', 'å—æ¸¯è»Ÿé«”åœ’å€', 'æ˜†é™½'], 'æ–‡å±±å€': ['å‹•ç‰©åœ’', 'æœ¨æŸµ', 'è¬èŠ³é†«é™¢', 'è¬èŠ³ç¤¾å€', 'æ™¯ç¾', 'è¬éš†'] }, 'NewTaipei': { 'æ¿æ©‹å€': ['æ¿æ©‹', 'åºœä¸­', 'æ–°åŸ”', 'æ±Ÿå­ç¿ ', 'äºæ±é†«é™¢'], 'ä¸‰é‡å€': ['ä¸‰é‡', 'èœå¯®', 'å°åŒ—æ©‹', 'ä¸‰é‡åœ‹å°', 'ä¸‰å’Œåœ‹ä¸­', 'å¾åŒ¯ä¸­å­¸'], 'ä¸­å’Œå€': ['æ™¯å®‰', 'å—å‹¢è§’', 'æ°¸å®‰å¸‚å ´', 'ä¸­å’Œ'], 'æ°¸å’Œå€': ['é ‚æºª', 'æ°¸å®‰å¸‚å ´'], 'æ–°èŠå€': ['æ–°èŠ', 'è¼”å¤§', 'ä¸¹é³³', 'è¿´é¾', 'é ­å‰åº„'], 'æ–°åº—å€': ['æ–°åº—', 'ä¸ƒå¼µ', 'å¤§åªæ—', 'å°ç¢§æ½­', 'æ–°åº—å€å…¬æ‰€'], 'æ·¡æ°´å€': ['æ·¡æ°´', 'ç´…æ¨¹æ—', 'ç«¹åœ'], 'æ—å£å€': ['æ—å£'] } };


/* --- 2. é‚è¼¯æ ¡æº–ï¼š100% å›æ­¸æ‚¨çš„ Code.gs --- */
function getUsageInfo(userApiKey) {
    if (!userApiKey) return { remaining: 0, limit: DAILY_LIMIT };
    const today = new Date().toLocaleDateString("zh-TW");
    const keyId = "KEY_" + userApiKey.slice(-10);
    const lastDate = localStorage.getItem('DATE_' + keyId);
    let usageCount = parseInt(localStorage.getItem('COUNT_' + keyId) || '0');
    if (lastDate !== today) {
        usageCount = 0;
        localStorage.setItem('DATE_' + keyId, today);
        localStorage.setItem('COUNT_' + keyId, '0');
    }
    return { remaining: Math.max(0, DAILY_LIMIT - usageCount), limit: DAILY_LIMIT };
}

async function getAiRecommendation(requestData) {
    const { userApiKey, city, district, food, purpose, budget, people, filters, userTime, mrtStation } = requestData;
    if (!userApiKey) return { error: "NO_KEY", message: "è«‹è¨­å®š API Keyï¼" };
    const usage = getUsageInfo(userApiKey);
    if (usage.remaining <= 0) return { error: "LIMIT_REACHED", message: "æ­¤ API Key ä»Šæ—¥é…é¡å·²ç”¨å®Œï¼" };

    // ã€æ¨¡å‹æ ¡æº–ï¼šä½¿ç”¨æ‚¨åœ¨ GAS ç©©å®šé‹è¡Œçš„ gemini-2.5-flashã€‘
    const url = `https://generativelanguage.googleapis.com/v1/models/gemini-2.5-flash:generateContent?key=${userApiKey}`;
    
    let timeNote = filters.includes("ç‡Ÿæ¥­ä¸­") ? `ã€åš´æ ¼è¦æ±‚ï¼šç¾åœ¨æ˜¯ ${userTime}ã€‚ç›®å‰æ‰“çƒŠä¸­çµ•å°ç¦æ­¢æ¨è–¦ã€‚ã€‘` : "";
    let hiddenNote = filters.includes("éš±è—ç‰ˆ") ? `ã€éš±è—ç‰ˆè¦æ±‚ï¼šåš´æ ¼é¿é–‹ Google è©•è«–æ•¸éé«˜ï¼ˆå¦‚ >2000 å‰‡ï¼‰çš„ååº—ï¼Œå„ªå…ˆå°‹æ‰¾å··å¼„ç§æˆ¿åº—ã€‚ã€‘` : "";
    let transNote = mrtStation ? `ã€çµ•å°äº¤é€šè¦æ±‚ï¼šåœ°é»å¿…é ˆä½æ–¼ã€Œ${mrtStation}ã€ç«™æ­¥è¡Œ 500 å…¬å°ºå…§ï¼ˆ5-10åˆ†é˜è·¯ç¨‹ï¼‰ã€‚ä½ å¿…é ˆä»”ç´°æª¢ç´¢åœ°åœ–è³‡æ–™ï¼Œç¢ºä¿åœ°å€æ­£ç¢ºä¸”é„°è¿‘è©²ç«™ã€‚å³ä½¿è©²ç«™åœ¨è¡Œæ”¿å€é‚Šç•Œï¼Œä¹Ÿæ‡‰ä»¥é„°è¿‘è©²ç«™ç‚ºæœ€å„ªå…ˆæ¢ä»¶ã€‚ã€‘` : "";

    const prompt = `ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„å°ç£ç¾é£Ÿå°è¦½å“¡ã€‚
        ã€æ“ä½œæº–å‰‡ï¼šçµ•å°çœŸå¯¦ã€‘
        1. åº—åå¿…é ˆèˆ‡ Google Maps ä¸Šçš„å®˜æ–¹åç¨±ã€Œå®Œå…¨ä¸€è‡´ã€ï¼Œåš´ç¦è™›æ§‹æˆ–çµ„åˆåç¨±ã€‚
        2. ä½ å¿…é ˆæä¾›è©²åº—å®¶çœŸå¯¦çš„ç¶“ç·¯åº¦ (lat, lng)ï¼Œç²¾ç¢ºåˆ°å°æ•¸é»å¾Œ 6 ä½ã€‚é€™å°‡ç”¨æ–¼è¨ˆç®—èˆ‡ä½¿ç”¨è€…çš„ç›´ç·šè·é›¢ã€‚
        3. ${timeNote} ${hiddenNote} ${transNote}
        
        æœå°‹æ¢ä»¶ï¼š
        åœ°é»ï¼š${city}${district} ${mrtStation ? '(é„°è¿‘'+mrtStation+'ç«™)' : ''}
        ç¨®é¡ï¼š${food}
        é ç®—ï¼š${budget}
        ç›®çš„ï¼š${purpose}

        è«‹åªå›å‚³ 5 é–“çœŸå¯¦å­˜åœ¨çš„é¤å»³ JSON é™£åˆ—ï¼š
        [{ 
          "name":"å®˜æ–¹å®Œæ•´åº—å", 
          "rating":"4.5", 
          "hours":"ç‡Ÿæ¥­æ™‚é–“", 
          "price":"åƒ¹ä½", 
          "signature":"æ¨è–¦èœè‰²", 
          "review_summary":"è©•è«–ç¸½çµ", 
          "address":"çœŸå¯¦åœ°å€", 
          "lat": 25.0, 
          "lng": 121.0 
        }]`;

    try {
        const response = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
        });
        
        const result = await response.json();
        
        if (result.error) return { error: result.error.message };
        
        let text = result.candidates[0].content.parts[0].text;
        text = text.replace(/```json/gi, "").replace(/```/gi, "").trim();
        const parsedData = JSON.parse(text);
        
        const keyId = "KEY_" + userApiKey.slice(-10);
        const newCount = (DAILY_LIMIT - usage.remaining) + 1;
        localStorage.setItem(`COUNT_${keyId}`, newCount.toString());
        return { data: parsedData, newRemaining: DAILY_LIMIT - newCount };
    } catch (e) { return { error: "AI å¿™ç¢Œä¸­ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚" }; }
}

/* --- 3. UI æ§åˆ¶é‚è¼¯ --- */
const bg = document.getElementById('bg-container'); 
images.forEach((url, i) => { const div = document.createElement('div'); div.className = 'bg-slide' + (i===0?' active':''); div.style.backgroundImage = `url('${url}?auto=format&fit=crop&w=1200')`; bg.appendChild(div); });
let slideIdx = 0; setInterval(() => { const s = document.querySelectorAll('.bg-slide'); s[slideIdx].classList.remove('active'); slideIdx = (slideIdx+1)%s.length; s[slideIdx].classList.add('active'); }, 6000);

function updateDistricts() { const city = document.getElementById('city').value; const distSelect = document.getElementById('district'); distSelect.innerHTML = cityData[city].map(d => `<option value="${d}">${d}</option>`).join(''); }
updateDistricts();

function checkTransAvailability() {
    const city = document.getElementById('city').value;
    const district = document.getElementById('district').value;
    const transport = document.getElementById('transport').value;
    const mrtSec = document.getElementById('mrt-section');
    const mrtSel = document.getElementById('mrt-station');
    const label = document.getElementById('trans-label');
    if (transport === 'none') { mrtSec.style.display = 'none'; return; }
    mrtSec.style.display = 'block';
    if (transport === 'mrt') {
        label.innerText = "ğŸš‡ æŒ‡å®šæ·é‹ç«™ (ä¾ç·šè·¯åˆ†é¡)";
        let linesData = (city === 'Taipei' ? mrtLinesTaipei : (city === 'NewTaipei' ? mrtLinesNewTaipei : (city === 'Taoyuan' ? mrtLinesTaoyuan : (city === 'Taichung' ? mrtLinesTaichung : (city === 'Kaohsiung' ? mrtLinesKaohsiung : null)))));
        if (district === 'å…¨å€' && linesData) {
            let html = '<option value="">--- è«‹é¸æ“‡æ·é‹ç«™ ---</option>';
            for (const line in linesData) { html += `<optgroup label="${line}">`; linesData[line].forEach(s => html += `<option value="${s}">${s}ç«™</option>`); html += `</optgroup>`; }
            mrtSel.innerHTML = html;
        } else if (mrtMap[city] && mrtMap[city][district]) {
            mrtSel.innerHTML = '<option value="">--- è«‹é¸æ“‡ ---</option>' + mrtMap[city][district].map(s => `<option value="${s}">${s}ç«™</option>`).join('');
        } else { mrtSel.innerHTML = '<option value="">è©²å€æš«ç„¡æ·é‹ç«™</option>'; }
    } else {
        let currentMap = (transport === 'train' ? trainMap : (transport === 'hsr' ? hsrMap : airportMap));
        label.innerText = `ğŸš‰ æŒ‡å®š${transport === 'train' ? 'ç«è»Š' : (transport === 'hsr' ? 'é«˜éµ' : 'æ©Ÿå ´')}ç«™`;
        if (currentMap[city]) {
            let list = (district === 'å…¨å€' ? Object.values(currentMap[city]).flat() : (currentMap[city][district] || []));
            list = [...new Set(list)].sort();
            mrtSel.innerHTML = '<option value="">--- è«‹é¸æ“‡ ---</option>' + list.map(s => `<option value="${s}">${s}${s.includes('æ©Ÿå ´')?'':'ç«™'}</option>`).join('');
        } else { mrtSel.innerHTML = '<option value="">è©²å€æš«ç„¡ç«™é»</option>'; }
    }
}

function saveApiKey() { const key = document.getElementById('api-key-input').value.trim(); if (!key) { alert("è«‹è¼¸å…¥æœ‰æ•ˆ Keyï¼"); return; } localStorage.setItem('EXPLORER_FINAL_SECURE_KEY', key); document.getElementById('api-overlay').style.display = 'none'; refreshUsage(); }
function getStoredKey() { return localStorage.getItem('EXPLORER_FINAL_SECURE_KEY') || ""; }
function refreshUsage() { const key = getStoredKey(); const usage = getUsageInfo(key); updateUsageDisplay(usage.remaining); }
window.onload = function() { const saved = getStoredKey(); if (saved) { document.getElementById('api-key-input').value = saved; refreshUsage(); } };
function updateUsageDisplay(count) { document.getElementById('usage-text').innerText = `ä»Šæ—¥å‰©é¤˜æ¬¡æ•¸ï¼š${count} æ¬¡`; const btn = document.getElementById('search-btn'); if(count <= 0) { btn.disabled = true; btn.innerText = "é¡åº¦å·²æ»¿"; } else { btn.disabled = false; btn.innerText = "é–‹å§‹æ¢ç´¢ç¾é£Ÿ"; } }

let currentLikedList = []; let cardsRemaining = 0; let swipedCount = 0; let roundCounter = 1;
function handleSearchClick() { if (!getStoredKey()) { document.getElementById('api-overlay').style.display = 'flex'; return; } startSearch(); }

/* --- äº¤é€šé©—è­‰é‚è¼¯ --- */
async function startSearch() {
    const cityKey = document.getElementById('city').value;
    const cityName = document.getElementById('city').options[document.getElementById('city').selectedIndex].text;
    const transport = document.getElementById('transport').value;
    const btn = document.getElementById('search-btn');
    const loader = document.getElementById('loader');
    
    const hasMRT = ['Taipei', 'NewTaipei', 'Taoyuan', 'Taichung', 'Kaohsiung'];
    const hasHSR = ['Taipei', 'NewTaipei', 'Taoyuan', 'HsinchuCounty', 'Miaoli', 'Taichung', 'Changhua', 'Yunlin', 'ChiayiCounty', 'Tainan', 'Kaohsiung'];
    const hasAirport = ['Taipei', 'Taoyuan', 'Taichung', 'Tainan', 'Kaohsiung', 'ChiayiCounty', 'Hualien', 'Taitung', 'Penghu', 'Kinmen', 'Lienchiang'];
    
    if (transport === 'mrt' && !hasMRT.includes(cityKey)) { alert(`âš ï¸ ${cityName} ç›®å‰æ²’æœ‰æ·é‹ã€‚`); return; }
    if (transport === 'hsr' && !hasHSR.includes(cityKey)) { alert(`âš ï¸ ${cityName} ç›®å‰æ²’æœ‰é«˜éµã€‚`); return; }
    if (transport === 'airport' && !hasAirport.includes(cityKey)) { alert(`âš ï¸ ${cityName} ç›®å‰æ²’æœ‰æ©Ÿå ´ã€‚`); return; }

    btn.disabled = true; btn.innerText = "æœå°‹ä¸­..."; loader.style.display = 'flex';
    const now = new Date(); const days = ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'];
    const userTimeString = `${days[now.getDay()]} ${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;
    const data = { userApiKey: getStoredKey(), city: cityName, district: document.getElementById('district').value, food: document.getElementById('food').options[document.getElementById('food').selectedIndex].text, purpose: document.getElementById('purpose').options[document.getElementById('purpose').selectedIndex].text, budget: document.getElementById('budget').options[document.getElementById('budget').selectedIndex].text, people: document.getElementById('people').value, userTime: userTimeString, mrtStation: document.getElementById('mrt-station').value, filters: (document.getElementById('btn-hidden').classList.contains('selected') ? "éš±è—ç‰ˆ " : "") + (document.getElementById('btn-open').classList.contains('selected') ? "ç‡Ÿæ¥­ä¸­ " : "") + (document.getElementById('transport').options[document.getElementById('transport').selectedIndex].text) };

    const res = await getAiRecommendation(data);
    loader.style.display = 'none'; btn.disabled = false; btn.innerText = "é–‹å§‹æ¢ç´¢ç¾é£Ÿ"; 
    if(res.error) { alert(res.error); return; } 
    if(!res.data || res.data.length === 0) { alert("ğŸ” æ‰¾ä¸åˆ°ç¬¦åˆäº¤é€šè¦æ±‚çš„åº—å®¶ï¼Œè«‹æ”¾å¯¬æ¢ä»¶ï¼"); resetUI(); return; } 
    updateUsageDisplay(res.newRemaining); renderCards(res.data);
}

function renderCards(restaurants) {
    document.getElementById('main-ui').classList.add('blur-mode');
    const stack = document.getElementById('card-stack'); 
    stack.innerHTML = '';
    document.getElementById('swiper-overlay').style.display = 'flex';
    
    currentLikedList = []; 
    swipedCount = 0; 
    cardsRemaining = restaurants.length;
    document.getElementById('round-info').innerText = "å·¦å³æ»‘å‹•ç¯©é¸";

    restaurants.forEach((res) => {
        // ä½¿ç”¨å³æ™‚æŠ“åˆ°çš„ userCoords
        const distStr = calculateDistance(userCoords.lat, userCoords.lng, res.lat, res.lng);
        
        const wrapper = document.createElement('div'); 
        wrapper.className = 'swipe-card-wrapper';
        const card = document.createElement('div'); 
        card.className = 'swipe-card';
        
        card.innerHTML = `
            <div class="swipe-hints"><div class="hint-item">â† NOPE</div><div class="hint-item">LIKE â†’</div></div>
            <div class="swipe-label label-like">LIKE</div>
            <div class="swipe-label label-nope">NOPE</div>
            <div class="label-chosen">ğŸ† æœ€çµ‚é¦–é¸</div>
            <h3>${res.name}</h3>
            <div class="card-badges">
                <span class="card-badge badge-rating">â­ ${res.rating}</span>
                <span class="card-badge badge-price">ğŸ’° ${res.price}</span>
                <span class="card-badge badge-distance">ğŸ“ ${distStr}</span>
            </div>
            <div class="info-row"><span class="info-label">ğŸ•’ ç‡Ÿæ¥­</span><span>${res.hours}</span></div>
            <div class="info-row"><span class="info-label">ğŸ”¥ æ‹›ç‰Œ</span><span>${res.signature}</span></div>
            <div class="card-summary">"${res.review_summary}"</div>
            <a class="card-map-btn" href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(res.name + ' ' + res.address)}" target="_blank">ğŸ—ºï¸ æŸ¥çœ‹ Google åœ°åœ–</a>
        `;
        wrapper.appendChild(card); 
        stack.appendChild(wrapper); 
        initSwipe(card, wrapper, res, restaurants.length === 1);
    });
    stack.scrollTo(0, 0); 
}

function initSwipe(el, wrapper, resData, isLastOne) {
    let startX, moveX = 0; let isDone = false;
    const likeLabel = el.querySelector('.label-like'); const nopeLabel = el.querySelector('.label-nope');
    el.addEventListener('touchstart', (e) => { if (isDone || e.target.tagName === 'A') return; startX = e.touches[0].clientX; el.style.transition = 'none'; }, {passive: true});
    el.addEventListener('touchmove', (e) => { if (isDone || !startX) return; moveX = e.touches[0].clientX - startX; if(Math.abs(moveX) > 10) { el.style.transform = `translateX(${moveX}px) rotate(${moveX/20}deg)`; likeLabel.style.opacity = moveX > 0 ? Math.min(moveX / 100, 1) : 0; nopeLabel.style.opacity = moveX < 0 ? Math.min(Math.abs(moveX) / 100, 1) : 0; } }, {passive: false});
    el.addEventListener('touchend', () => { 
        if (isDone || !startX) return; el.style.transition = '0.4s ease'; 
        if (Math.abs(moveX) > 100) { 
            const dir = moveX > 0 ? 1 : -1; 
            if (isLastOne && dir === -1) { el.style.transform = `translateX(-150%)`; setTimeout(() => { alert("é‡æ–°æ¢ç´¢å§ï¼"); resetUI(); }, 300); } 
            else if (dir === 1 && isLastOne) { el.style.transform = 'translateX(0)'; likeLabel.style.opacity = 0; nopeLabel.style.opacity = 0; const stamp = el.querySelector('.label-chosen'); if(stamp) stamp.classList.add('active'); document.getElementById('round-info').innerText = "ğŸ† æ‚¨çš„æœ€ä½³é¦–é¸"; isDone = true; } 
            else { if (dir === 1) currentLikedList.push(resData); finishSwipe(el, wrapper, dir); }
        } else { el.style.transform = 'translateX(0) rotate(0deg)'; likeLabel.style.opacity = 0; nopeLabel.style.opacity = 0; } startX = null; 
    });
}
function finishSwipe(el, wrapper, dir) { el.style.transform = `translateX(${dir * 150}%)`; el.style.opacity = '0'; setTimeout(() => { wrapper.remove(); swipedCount++; if(swipedCount === cardsRemaining) { if(currentLikedList.length > 0) { roundCounter++; renderCards(currentLikedList); } else { alert("é‡æ–°æ¢ç´¢å§ï¼"); resetUI(); } } }, 300); }
function resetUI() { document.getElementById('swiper-overlay').style.display = 'none'; document.getElementById('main-ui').classList.remove('blur-mode'); roundCounter = 1; }
document.addEventListener('touchmove', function(e) { const stack = document.getElementById('card-stack'); const overlay = document.getElementById('swiper-overlay'); if (overlay.style.display === 'flex') { if (stack.contains(e.target)) { if (stack.scrollHeight > stack.clientHeight) return; } } e.preventDefault(); }, { passive: false });

</script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>TasteExplorer - ç¾å‘³æ¢ç´¢</title>
    <link rel="icon" href="favicon.png" type="image/png">
    <link rel="apple-touch-icon" href="favicon.png">
    <style>
        /* --- 1. æ ¸å¿ƒæ¨£å¼ï¼š100% åŸå°ä¸å‹• --- */
        :root {
            --primary-orange: #FF6600;
            --glass-bg: rgba(25, 25, 25, 0.85);
            --glass-border: rgba(255, 255, 255, 0.15);
            --input-bg: rgba(255, 255, 255, 0.1);
            --text-color: #ffffff;
            --label-color: #cccccc;
            --accent-yellow: #FFCC00;
        }

        html, body { overscroll-behavior-y: none; height: 100%; overflow: hidden; position: fixed; width: 100%; margin: 0; padding: 0; background-color: #000; }
        html { font-size: 14px; } 
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, "SF Pro Text", "Helvetica Neue", sans-serif; }
        body { color: #fff; display: flex; align-items: center; justify-content: center; }

        #bg-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; }
        .bg-slide { position: absolute; width: 100%; height: 100%; background-size: cover; background-position: center; opacity: 0; transition: opacity 1s; }
        .bg-slide.active { opacity: 0.6; }

        #api-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.5); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); 
            z-index: 5000; display: none; flex-direction: column; align-items: center; justify-content: center; 
            padding: 40px 20px; text-align: center; 
        }
        .api-card { width: 100%; max-width: 340px; background: rgba(20, 20, 20, 0.8); border: 1px solid var(--glass-border); border-radius: 24px; padding: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
        .api-input { width: 100%; background: var(--input-bg); border: 1px solid var(--glass-border); border-radius: 12px; padding: 15px; color: white; font-size: 1rem; margin-bottom: 15px; text-align: center; }
        .api-save-btn { width: 100%; background: var(--primary-orange); color: white; border: none; padding: 14px; border-radius: 12px; font-weight: bold; cursor: pointer; }

        .container { 
            width: 95%; max-width: 357px; height: 100dvh; z-index: 10; 
            display: flex; flex-direction: column; 
            justify-content: space-evenly; 
            align-items: center; padding: 10px 0; position: relative; 
            transition: transform 0.3s ease, filter 0.3s ease;
        }
        .container.blur-mode { filter: blur(15px) brightness(0.4); transform: scale(0.95); pointer-events: none; }

        .header { width: 100%; flex: 0 0 auto; display: flex; flex-direction: column; align-items: center; position: relative; }
        .logo { font-size: 2.77rem; font-weight: 800; color: var(--primary-orange); line-height: 1.1; letter-spacing: -1px; margin: 0; }
        .tagline { font-size: 1.2rem; color: #ffffff; opacity: 0.8; margin-top: 6px; }
        .settings-btn { position: absolute; top: 0; right: 0; height: 3rem; display: flex; align-items: center; font-size: 24px; cursor: pointer; z-index: 50; padding: 0 5px; }

        .glass-card { 
            width: 100%; background: rgba(20, 20, 20, 0.75); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); 
            border-radius: 24px; padding: 18px; border: 1px solid var(--glass-border); 
            flex: 0 0 auto; display: flex; flex-direction: column; gap: 12px;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .location-status {
            width: 100%; font-size: 0.8rem; color: #fff; background: var(--input-bg); 
            padding: 10px; border-radius: 12px; display: flex; align-items: center; justify-content: center; gap: 8px;
            border: 1px solid transparent; cursor: pointer; transition: 0.3s; margin-bottom: 5px;
        }
        .location-status.active-mode { 
            background: rgba(255, 204, 0, 0.15) !important; color: var(--accent-yellow) !important;
            border-color: rgba(255, 204, 0, 0.4); box-shadow: 0 0 15px rgba(255, 204, 0, 0.1); 
        }
        .location-dot { width: 8px; height: 8px; background: #2ecc71; border-radius: 50%; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 6px rgba(46, 204, 113, 0); } 100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(46, 204, 113, 0); } }

        .hide-field { display: none !important; }

        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .full-width { grid-column: span 2; }
        label { font-size: 0.75rem; color: #ffffff; margin-bottom: 4px; display: block; font-weight: 600; }
        .input-box { background: var(--input-bg); border-radius: 10px; height: 38px; display: flex; align-items: center; padding: 0 10px; border: 1px solid transparent; transition: 0.3s; }
        .input-box:focus-within { border-color: var(--primary-orange); box-shadow: 0 0 8px rgba(255, 102, 0, 0.3); }
        select { background: transparent; border: none; color: white; width: 100%; outline: none; font-size: 0.85rem; appearance: none; -webkit-appearance: none; cursor: pointer; }
        select option { background-color: #222; }

        .toggle-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 4px; }
        .toggle-btn { background: var(--input-bg); height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 1px solid transparent; font-size: 0.85rem; transition: 0.3s; }
        .toggle-btn.selected { background: rgba(255,102,0,0.2); border-color: var(--primary-orange); color: var(--primary-orange); font-weight: bold; }
        #btn-open.selected { background: rgba(46,204,113,0.15); border-color: #2ecc71; color: #2ecc71; }

        .footer-action { width: 100%; flex: 0 0 auto; display: flex; flex-direction: column; align-items: center; }
        .cta-button { width: 100%; background: linear-gradient(180deg, #FF8533, #FF6600); border: none; padding: 16px; font-weight: 700; border-radius: 16px; color: #fff; cursor: pointer; font-size: 1.1rem; box-shadow: 0 4px 15px rgba(255, 102, 0, 0.4); transition: 0.3s; }
        /* ä¿®æ­£ 2: è®“æœå°‹ä¸­çš„æŒ‰éˆ•ä¿æŒæ©˜è‰² */
        .cta-button:disabled { background: linear-gradient(180deg, #FF8533, #FF6600); opacity: 0.9; cursor: not-allowed; box-shadow: none; }
        
        .usage-hint { font-size: 0.85rem; opacity: 0.7; color: #ffffff; font-weight: 500; flex: 0 0 auto; }

        #swiper-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; display: none; flex-direction: column; align-items: center; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); }
        /* ä¿®æ­£ 1: ç§»é™¤ overflow-y: auto ä»¥åˆªé™¤å³å´æ‹‰éœ¸ */
        .card-stack { width: 100%; max-width: 340px; height: 100%; display: flex; flex-direction: column; align-items: center; padding: 20px 0 120px 0; gap: 20px; overflow-x: hidden; }
        
        .swipe-card-wrapper { width: 92%; flex-shrink: 0; transition: transform 0.4s ease, opacity 0.4s ease; position: relative; }
        .swipe-card { width: 100%; background: var(--glass-bg); border-radius: 24px; border: 1px solid var(--glass-border); padding: 20px; display: flex; flex-direction: column; gap: 8px; position: relative; overflow: hidden; }

        .swipe-hints { position: absolute; top: 12px; left: 0; width: 100%; display: flex; justify-content: space-between; padding: 0 15px; pointer-events: none; z-index: 5; }
        .hint-item { font-size: 0.65rem; font-weight: bold; color: rgba(255,255,255,0.3); border: 1px solid rgba(255,255,255,0.15); padding: 2px 6px; border-radius: 4px; text-transform: uppercase; letter-spacing: 0.5px; }

        .swipe-label { position: absolute; top: 30px; padding: 5px 15px; border: 4px solid; border-radius: 10px; font-size: 2rem; font-weight: 900; text-transform: uppercase; opacity: 0; pointer-events: none; z-index: 10; }
        .label-like { right: 20px; color: #2ecc71; border-color: #2ecc71; transform: rotate(15deg); }
        .label-nope { left: 20px; color: #e74c3c; border-color: #e74c3c; transform: rotate(-15deg); }
        .label-chosen { position: absolute; top: 20px; left: 20px; padding: 5px 15px; border: 4px solid #2ecc71; color: #2ecc71; border-radius: 10px; font-size: 1.8rem; font-weight: 900; opacity: 0; pointer-events: none; z-index: 20; transform: scale(5); transition: all 0.4s; background: rgba(0,0,0,0.3); }
        .label-chosen.active { opacity: 1; transform: scale(1) rotate(-15deg); }

        .card-badge { padding: 3px 10px; border-radius: 6px; font-size: 0.75rem; font-weight: bold; }
        .badge-rating { background: var(--accent-yellow); color: #000; }
        .badge-price { background: rgba(255,255,255,0.1); color: #eee; }
        .badge-distance { background: var(--primary-orange); color: #fff; }

        .info-row { font-size: 0.85rem; display: flex; gap: 6px; color: #ddd; line-height: 1.4; }
        .info-label { color: var(--primary-orange); font-weight: bold; flex-shrink: 0; }
        .card-summary { font-size: 0.88rem; font-style: italic; opacity: 0.85; border-left: 2px solid var(--primary-orange); padding-left: 10px; margin: 5px 0; }
        .card-map-btn { background: var(--primary-orange); color: #fff; text-decoration: none; padding: 12px; border-radius: 14px; text-align: center; font-weight: bold; margin-top: 10px; }
        
        .close-swiper { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 12px 40px; border-radius: 50px; cursor: pointer; font-weight: bold; backdrop-filter: blur(10px); margin: 20px 0 40px 0; flex-shrink: 0; }

        #loader { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 9999; flex-direction: column; align-items: center; justify-content: center; background: rgba(0,0,0,0.6); }
        .spinner { width: 50px; height: 50px; border: 5px solid rgba(255,102,0,0.1); border-top: 5px solid var(--primary-orange); border-radius: 50%; animation: spin 1s linear infinite !important; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body touch-action="none">
    <div id="api-overlay">
        <div class="api-card">
            <h2>ğŸ”‘ API è¨­å®š</h2>
            <p>è«‹è¼¸å…¥æ‚¨çš„ Gemini API Keyã€‚<br>è¨­å®šå¾Œäº«æœ‰ç¨ç«‹çš„æ¯æ—¥ 15 æ¬¡é…é¡ã€‚</p>
            <input type="password" id="api-key-input" class="api-input" placeholder="è²¼ä¸Šæ‚¨çš„ API Key (AIza...)">
            <button class="api-save-btn" onclick="saveApiKey()">ç¢ºèªä¸¦å„²å­˜</button>
            <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color:var(--accent-yellow); font-size:0.85rem; display:block; margin-top:15px;">ğŸ‘‰ é»æ­¤ç”³è«‹æ‚¨çš„ API Key</a>
            <button onclick="document.getElementById('api-overlay').style.display='none'" style="background:none; border:none; color:#777; margin-top:20px;">è¿”å›é¦–é </button>
        </div>
    </div>

    <div id="bg-container"></div>
    <div id="loader"><div class="spinner"></div><p style="color:white; margin-top:15px; font-weight:bold;">æ­£åœ¨å··å¼„æ¢ç´¢ä¸­...</p></div>

    <div class="container" id="main-ui">
        <div class="header">
            <div class="logo">TasteExplorer</div>
            <div class="settings-btn" onclick="document.getElementById('api-overlay').style.display='flex'">âš™ï¸</div>
            <div class="tagline">æ¢ç´¢éš±è—ç¾å‘³ äº«å—æ¥µè‡´é¥—å®´</div>
        </div>

        <div class="glass-card">
            <div id="location-display" class="location-status" onclick="toggleNearbyMode()">
                <div class="location-dot"></div>
                <span id="coords-text">æ­£åœ¨å–å¾— GPS åº§æ¨™...</span>
            </div>

            <div class="form-grid">
                <div class="form-group nearby-toggle"><label>ğŸ“ ç¸£å¸‚</label><div class="input-box"><select id="city" onchange="updateDistricts(); checkTransAvailability();">
                    <optgroup label="åŒ—éƒ¨åœ°å€"><option value="Taipei" selected>å°åŒ—å¸‚</option><option value="NewTaipei">æ–°åŒ—å¸‚</option><option value="Keelung">åŸºéš†å¸‚</option><option value="Taoyuan">æ¡ƒåœ’å¸‚</option><option value="HsinchuCity">æ–°ç«¹å¸‚</option><option value="HsinchuCounty">æ–°ç«¹ç¸£</option><option value="Yilan">å®œè˜­ç¸£</option></optgroup>
                    <optgroup label="ä¸­éƒ¨åœ°å€"><option value="Miaoli">è‹—æ —ç¸£</option><option value="Taichung">å°ä¸­å¸‚</option><option value="Changhua">å½°åŒ–ç¸£</option><option value="Nantou">å—æŠ•ç¸£</option><option value="Yunlin">é›²æ—ç¸£</option></optgroup>
                    <optgroup label="å—éƒ¨åœ°å€"><option value="ChiayiCity">å˜‰ç¾©å¸‚</option><option value="ChiayiCounty">å˜‰ç¾©ç¸£</option><option value="Tainan">å°å—å¸‚</option><option value="Kaohsiung">é«˜é›„å¸‚</option><option value="Pingtung">å±æ±ç¸£</option></optgroup>
                    <optgroup label="æ±éƒ¨èˆ‡é›¢å³¶"><option value="Hualien">èŠ±è“®ç¸£</option><option value="Taitung">å°æ±ç¸£</option><option value="Penghu">æ¾æ¹–ç¸£</option><option value="Kinmen">é‡‘é–€ç¸£</option><option value="Lienchiang">é€£æ±Ÿç¸£</option></optgroup>
                </select></div></div>
                <div class="form-group nearby-toggle"><label>ğŸ™ï¸ è¡Œæ”¿å€</label><div class="input-box"><select id="district" onchange="checkTransAvailability();"><option>å…¨å€</option></select></div></div>
                <div class="form-group full-width nearby-toggle"><label>ğŸš† äº¤é€šåå¥½</label><div class="input-box"><select id="transport" onchange="checkTransAvailability()">
                    <option value="none" selected>ğŸ¤·â€â™‚ï¸ ä¸æ‹˜</option>
                    <option value="mrt">ğŸš‡ é„°è¿‘æ·é‹ç«™ (æ­¥è¡Œå¯é”)</option>
                    <option value="hsr">ğŸš„ é„°è¿‘é«˜éµç«™ (æ­¥è¡Œå¯é”)</option>
                    <option value="train">ğŸš‚ é„°è¿‘ç«è»Šç«™ (æ­¥è¡Œå¯é”)</option>
                    <option value="airport">âœˆï¸ é„°è¿‘æ©Ÿå ´ (æ­¥è¡Œå¯é”)</option>
                </select></div></div>
                
                <div class="form-group full-width" id="mrt-section" style="display:none;"><label id="trans-label">ğŸš‰ æŒ‡å®šç«™é»</label><div class="input-box"><select id="mrt-station"></select></div></div>
                <div class="form-group full-width"><label>ğŸ¤¤ æƒ³åƒä»€éº¼ï¼Ÿ</label><div class="input-box"><select id="food">
                    <option value="all">å…¨éƒ¨ (ä»€éº¼éƒ½æƒ³åƒ)</option>
                    <optgroup label="ğŸ”¥ ç†±é–€ç²¾é¸"><option value="hotpot">ç«é‹ / éº»è¾£é‹ / æ¶®æ¶®é‹</option><option value="bbq">ç‡’è‚‰ / æ—¥å¼çƒ¤è‚‰ / éŸ“å¼çƒ¤è‚‰</option><option value="steak">ç‰›æ’ / éµæ¿ç‡’</option><option value="buffet">åƒåˆ°é£½ (Buffet)</option></optgroup>
                    <optgroup label="ğŸœ å°å¼èˆ‡ä¸­å¼"><option value="taiwanese_snack">å°ç£å°åƒ / è·¯é‚Šæ”¤</option><option value="beef_noodle">ç‰›è‚‰éºµ</option><option value="rechao">æµ·é®®ç†±ç‚’ / åˆèœ</option><option value="hot_soup">æ»·å‘³ / é¹½é…¥é› / å®µå¤œ</option></optgroup>
                    <optgroup label="ğŸ£ æ—¥å¼æ–™ç†"><option value="ramen">æ—¥å¼æ‹‰éºµ / çƒé¾éºµ</option><option value="sushi">å£½å¸ / ç”Ÿé­šç‰‡ / ä¸¼é£¯</option><option value="izakaya">å±…é…’å±‹ / ä¸²ç‡’</option><option value="curry">æ—¥å¼å’–å“© / å®šé£Ÿ</option></optgroup>
                    <optgroup label="ğŸŒ ç•°åœ‹é¢¨å‘³"><option value="korean">éŸ“å¼æ–™ç† / ç‚¸é›</option><option value="thai_viet">æ³°å¼ / è¶Šå¼æ–™ç†</option><option value="american">ç¾å¼æ¼¢å ¡ / ç‚¸ç‰©</option><option value="italian">ç¾©å¼æ–™ç† / æŠ«è–© / ç¾©å¤§åˆ©éºµ</option></optgroup>
                    <optgroup label="â˜• æ”¾é¬†æ™‚åˆ»"><option value="brunch">æ—©åˆé¤ (Brunch)</option><option value="cafe">å’–å•¡å»³ / ä¸‹åˆèŒ¶ / ç”œé»</option><option value="bistro">é¤é…’é¤¨ / Bar</option></optgroup>
                    <optgroup label="ğŸ¥¬ å…¶ä»–"><option value="vegetarian">ç´ é£Ÿ / è”¬é£Ÿ</option><option value="healthy">å¥åº·é¤ç›’ / è¼•é£Ÿ</option></optgroup>
                </select></div></div>
                <div class="form-group full-width"><label>ğŸ‘¥ äººæ•¸</label><div class="input-box"><select id="people"><option selected>1~2 äºº</option><option>2~4 äºº</option><option>4~6 äºº</option><option>6 äººä»¥ä¸Š</option></select></div></div>
                <div class="form-group full-width"><label>ğŸ¯ ç”¨é¤ç›®çš„</label><div class="input-box"><select id="purpose"><option>ğŸ¤·â€â™‚ï¸ ä¸æ‹˜ (éš¨æ„åƒåƒ)</option><option>ğŸ‘¯ æœ‹å‹èšé¤ (ç†±é¬§)</option><option>ğŸ’‘ æƒ…ä¾¶ç´„æœƒ (æ°£æ°›)</option><option>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å®¶åº­èšæœƒ (é•·è¼©/å°å­©)</option><option>ğŸ§˜ ä¸€äººç¨äº« (å®‰éœ)</option><option>ğŸ’¼ å•†å‹™å®´è«‹ (æ­£å¼)</option><option>ğŸŒ™ å®µå¤œå ´ (æ·±å¤œ)</option><option>ğŸ“¸ IGæ‰“å¡/ç¶²ç¾åº—</option><option>âš¡ å¿«é€Ÿè§£æ±º (è¶•æ™‚é–“)</option><option>ğŸ‰ æ…¶ç”Ÿ/ç´€å¿µæ—¥</option></select></div></div>
                <div class="form-group full-width"><label>ğŸ’° é ç®—ç¯„åœ</label><div class="input-box"><select id="budget"><option value="low">ğŸ’µ å¹³åƒ¹ (&lt;$300)</option><option value="mid">ğŸ’µğŸ’µ ä¸­åƒ¹ä½ ($300ï½$800)</option><option value="high">ğŸ’µğŸ’µğŸ’µ é«˜ç´š (&gt;$800)</option><option value="luxury">ğŸ’ é ‚ç´šå¥¢è¯ (&gt;$2000)</option></select></div></div>
                <div class="form-group full-width"><div class="toggle-row"><div id="btn-hidden" class="toggle-btn" onclick="this.classList.toggle('selected')">ğŸ¤« éš±è—ç‰ˆ</div><div id="btn-open" class="toggle-btn" onclick="this.classList.toggle('selected')">ğŸ•’ ç‡Ÿæ¥­ä¸­</div></div></div>
            </div>
        </div>

        <div class="footer-action">
            <button id="search-btn" class="cta-button" onclick="handleSearchClick()">é–‹å§‹æ¢ç´¢ç¾é£Ÿ</button>
        </div>
        
        <div id="usage-text" class="usage-hint">ä»Šæ—¥å‰©é¤˜æ¬¡æ•¸ï¼š-- æ¬¡</div>
    </div>

    <div id="swiper-overlay">
        <div class="card-stack" id="card-stack"></div>
    </div>

    <script>
        // --- æ•¸æ“šçµæ§‹ (ä¿ç•™åŸå§‹) ---
        const DAILY_LIMIT = 15;
        let userCoords = { lat: null, lng: null };
        let isNearbyMode = false;
        const images = ['https://images.unsplash.com/photo-1555939594-58d7cb561ad1', 'https://images.unsplash.com/photo-1594046243098-0fceea9d451e', 'https://images.unsplash.com/photo-1563245372-f21724e3856d', 'https://images.unsplash.com/photo-1512621776951-a57141f2eefd', 'https://images.unsplash.com/photo-1504674900247-0877df9cc836', 'https://images.unsplash.com/photo-1565299624946-b28f40a0ae38'];

        const cityData = { 'Taipei': ['å…¨å€', 'ä¸­æ­£å€', 'å¤§åŒå€', 'ä¸­å±±å€', 'æ¾å±±å€', 'å¤§å®‰å€', 'è¬è¯å€', 'ä¿¡ç¾©å€', 'å£«æ—å€', 'åŒ—æŠ•å€', 'å…§æ¹–å€', 'å—æ¸¯å€', 'æ–‡å±±å€'], 'NewTaipei': ['å…¨å€', 'æ¿æ©‹å€', 'ä¸‰é‡å€', 'ä¸­å’Œå€', 'æ°¸å’Œå€', 'æ–°èŠå€', 'æ–°åº—å€', 'åœŸåŸå€', 'è˜†æ´²å€', 'æ¨¹æ—å€', 'é¶¯æ­Œå€', 'ä¸‰å³½å€', 'æ·¡æ°´å€', 'æ±æ­¢å€', 'ç‘èŠ³å€', 'äº”è‚¡å€', 'æ³°å±±å€', 'æ—å£å€', 'æ·±å‘å€', 'çŸ³ç¢‡å€', 'åªæ—å€', 'ä¸‰èŠå€', 'çŸ³é–€å€', 'å…«é‡Œå€', 'å¹³æºªå€', 'é›™æºªå€', 'è²¢å¯®å€', 'é‡‘å±±å€', 'è¬é‡Œå€', 'çƒä¾†å€'], 'Keelung': ['å…¨å€', 'ä»æ„›å€', 'ä¿¡ç¾©å€', 'ä¸­æ­£å€', 'ä¸­å±±å€', 'å®‰æ¨‚å€', 'æš–æš–å€', 'ä¸ƒå µå€'], 'Taoyuan': ['å…¨å€', 'æ¡ƒåœ’å€', 'ä¸­å£¢å€', 'å¹³é®å€', 'å…«å¾·å€', 'æ¥Šæ¢…å€', 'è˜†ç«¹å€', 'å¤§æºªå€', 'é¾æ½­å€', 'é¾œå±±å€', 'å¤§åœ’å€', 'è§€éŸ³å€', 'æ–°å±‹å€', 'å¾©èˆˆå€'], 'HsinchuCity': ['å…¨å€', 'æ±å€', 'åŒ—å€', 'é¦™å±±å€'], 'HsinchuCounty': ['å…¨å€', 'ç«¹åŒ—å¸‚', 'ç«¹æ±é®', 'æ–°åŸ”é®', 'é—œè¥¿é®', 'æ¹–å£é„‰', 'æ–°è±é„‰', 'å³¨çœ‰é„‰', 'å¯¶å±±é„‰', 'åŒ—åŸ”é„‰', 'æ©«å±±é„‰', 'èŠæ—é„‰', 'å°–çŸ³é„‰', 'äº”å³°é„‰'], 'Yilan': ['å…¨å€', 'å®œè˜­å¸‚', 'ç¾…æ±é®', 'è˜‡æ¾³é®', 'é ­åŸé®', 'ç¤æºªé„‰', 'å£¯åœé„‰', 'å“¡å±±é„‰', 'å†¬å±±é„‰', 'äº”çµé„‰', 'ä¸‰æ˜Ÿé„‰', 'å¤§åŒé„‰', 'å—æ¾³é„‰'], 'Miaoli': ['å…¨å€', 'è‹—æ —å¸‚', 'é ­ä»½å¸‚', 'ç«¹å—é®', 'å¾Œé¾é®', 'é€šéœ„é®', 'è‹‘è£¡é®', 'å“è˜­é®', 'é€ æ©‹é„‰', 'è¥¿æ¹–é„‰', 'é ­å±‹é„‰', 'å…¬é¤¨é„‰', 'éŠ…é‘¼é„‰', 'ä¸‰ç¾©é„‰', 'å¤§æ¹–é„‰', 'ç…æ½­é„‰', 'ä¸‰ç£é„‰', 'å—åº„é„‰', 'æ³°å®‰é„‰'], 'Taichung': ['å…¨å€', 'ä¸­å€', 'æ±å€', 'å—å€', 'è¥¿å€', 'åŒ—å€', 'åŒ—å±¯å€', 'è¥¿å±¯å€', 'å—å±¯å€', 'å¤ªå¹³å€', 'å¤§é‡Œå€', 'éœ§å³°å€', 'çƒæ—¥å€', 'è±åŸå€', 'å¾Œé‡Œå€', 'çŸ³å²¡å€', 'æ±å‹¢å€', 'å’Œå¹³å€', 'æ–°ç¤¾å€', 'æ½­å­å€', 'å¤§é›…å€', 'ç¥å²¡å€', 'å¤§è‚šå€', 'é¾äº•å€', 'æ¢§æ£²å€', 'æ¸…æ°´å€', 'å¤§ç”²å€', 'å¤–åŸ”å€', 'å¤§å®‰å€'], 'Changhua': ['å…¨å€', 'å½°åŒ–å¸‚', 'å“¡æ—å¸‚', 'å’Œç¾é®', 'é¹¿æ¸¯é®', 'æºªæ¹–é®', 'äºŒæ—é®', 'ç”°ä¸­é®', 'åŒ—æ–—é®', 'èŠ±å£‡é„‰', 'èŠ¬åœ’é„‰', 'å¤§æ‘é„‰', 'æ°¸é–é„‰', 'ä¼¸æ¸¯é„‰', 'ç·šè¥¿é„‰', 'ç¦èˆˆé„‰', 'ç§€æ°´é„‰', 'åŸ”å¿ƒé„‰', 'åŸ”é¹½é„‰', 'å¤§åŸé„‰', 'èŠ³è‹‘é„‰', 'ç«¹å¡˜é„‰', 'ç¤¾é ­é„‰', 'äºŒæ°´é„‰', 'æºªå·é„‰', 'ç”°å°¾é„‰', 'åŸ¤é ­é„‰'], 'Nantou': ['å…¨å€', 'å—æŠ•å¸‚', 'åŸ”é‡Œé®', 'è‰å±¯é®', 'ç«¹å±±é®', 'é›†é›†é®', 'åé–“é„‰', 'é¹¿è°·é„‰', 'ä¸­å¯®é„‰', 'é­šæ± é„‰', 'åœ‹å§“é„‰', 'æ°´é‡Œé„‰', 'ä¿¡ç¾©é„‰', 'ä»æ„›é„‰'], 'Yunlin': ['å…¨å€', 'æ–—å…­å¸‚', 'æ–—å—é®', 'è™å°¾é®', 'è¥¿èºé®', 'åœŸåº«é®', 'åŒ—æ¸¯é®', 'å¤å‘é„‰', 'å¤§åŸ¤é„‰', 'è¿æ¡é„‰', 'æ—å…§é„‰', 'äºŒå´™é„‰', 'å´™èƒŒé„‰', 'éº¥å¯®é„‰', 'æ±å‹¢é„‰', 'è¤’å¿ é„‰', 'å°è¥¿é„‰', 'å…ƒé•·é„‰', 'å››æ¹–é„‰', 'å£æ¹–é„‰', 'æ°´æ—é„‰'], 'ChiayiCity': ['å…¨å€', 'æ±å€', 'è¥¿å€'], 'ChiayiCounty': ['å…¨å€', 'å¤ªä¿å¸‚', 'æœ´å­å¸‚', 'å¸ƒè¢‹é®', 'å¤§æ—é®', 'æ°‘é›„é„‰', 'æºªå£é„‰', 'æ–°æ¸¯é„‰', 'å…­è…³é„‰', 'æ±çŸ³é„‰', 'ç¾©ç«¹é„‰', 'é¹¿è‰é„‰', 'æ°´ä¸Šé„‰', 'ä¸­åŸ”é„‰', 'ç«¹å´é„‰', 'æ¢…å±±é„‰', 'ç•ªè·¯é„‰', 'å¤§åŸ”é„‰', 'é˜¿é‡Œå±±é„‰'], 'Tainan': ['å…¨å€', 'ä¸­è¥¿å€', 'æ±å€', 'å—å€', 'åŒ—å€', 'å®‰å¹³å€', 'å®‰å—å€', 'æ°¸åº·å€', 'æ­¸ä»å€', 'æ–°åŒ–å€', 'ç‰äº•å€', 'ä»å¾·å€', 'é—œå»Ÿå€', 'å®˜ç”°å€', 'éº»è±†å€', 'ä½³é‡Œå€', 'æ–°ç‡Ÿå€', 'å–„åŒ–å€'], 'Kaohsiung': ['å…¨å€', 'æ¥ æ¢“å€', 'å·¦ç‡Ÿå€', 'é¼“å±±å€', 'ä¸‰æ°‘å€', 'é¹½åŸ•å€', 'å‰é‡‘å€', 'æ–°èˆˆå€', 'è‹“é›…å€', 'å‰é®å€', 'æ——æ´¥å€', 'å°æ¸¯å€', 'é³³å±±å€', 'å¤§å¯®å€', 'é³¥æ¾å€', 'æ—åœ’å€', 'ä»æ­¦å€', 'å¤§æ¨¹å€', 'å¤§ç¤¾å€', 'å²¡å±±å€', 'è·¯ç«¹å€', 'æ——å±±å€', 'ç¾æ¿ƒå€'], 'Pingtung': ['å…¨å€', 'å±æ±å¸‚', 'æ½®å·é®', 'æ±æ¸¯é®', 'æ†æ˜¥é®', 'è¬ä¸¹é„‰', 'é•·æ²»é„‰', 'é‡Œæ¸¯é„‰', 'å…§åŸ”é„‰', 'æ‹å¯®é„‰', 'è»ŠåŸé„‰'], 'Hualien': ['å…¨å€', 'èŠ±è“®å¸‚', 'é³³æ—é®', 'ç‰é‡Œé®', 'æ–°åŸé„‰', 'å‰å®‰é„‰', 'å£½è±é„‰', 'å…‰å¾©é„‰', 'ç‘ç©—é„‰'], 'Taitung': ['å…¨å€', 'å°æ±å¸‚', 'æˆåŠŸé®', 'é—œå±±é®', 'å‘åé„‰', 'é¹¿é‡é„‰', 'æ± ä¸Šé„‰', 'ç¶ å³¶é„‰', 'è˜­å¶¼é„‰'], 'Penghu': ['å…¨å€', 'é¦¬å…¬å¸‚', 'æ¹–è¥¿é„‰', 'ç™½æ²™é„‰', 'è¥¿å¶¼é„‰'], 'Kinmen': ['å…¨å€', 'é‡‘åŸé®', 'é‡‘æ¹–é®', 'é‡‘æ²™é®', 'é‡‘å¯§é„‰'], 'Lienchiang': ['å…¨å€', 'å—ç«¿é„‰', 'åŒ—ç«¿é„‰', 'è’å…‰é„‰', 'æ±å¼•é„‰'] };
        
        // --- é€šç”¨åŠŸèƒ½ ---
        function calculateDistance(lat1, lon1, lat2, lon2) {
            if (!lat1 || !lon1 || !lat2 || !lon2) return "æœªçŸ¥";
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const d = R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return d < 1 ? `${(d * 1000).toFixed(0)}m` : `${d.toFixed(1)}km`;
        }

        function initLocationWatch() {
            if ("geolocation" in navigator) {
                navigator.geolocation.watchPosition((pos) => {
                    userCoords.lat = pos.coords.latitude; userCoords.lng = pos.coords.longitude;
                    if (!isNearbyMode) document.getElementById('coords-text').innerText = `ğŸ“ ${userCoords.lat.toFixed(4)}, ${userCoords.lng.toFixed(4)} (å·²åŒæ­¥)`;
                }, () => {}, { enableHighAccuracy: true });
            }
        }

        function toggleNearbyMode() {
            isNearbyMode = !isNearbyMode;
            const btn = document.getElementById('location-display');
            const fields = document.querySelectorAll('.nearby-toggle');
            if (isNearbyMode) {
                btn.classList.add('active-mode');
                fields.forEach(f => f.classList.add('hide-field'));
                document.getElementById('mrt-section').style.display = 'none';
                document.getElementById('coords-text').innerText = "ğŸ¯ æœå°‹é™„è¿‘ 1å…¬é‡Œ å…§ç¾é£Ÿ";
            } else {
                btn.classList.remove('active-mode');
                fields.forEach(f => f.classList.remove('hide-field'));
                document.getElementById('coords-text').innerText = userCoords.lat ? `ğŸ“ ${userCoords.lat.toFixed(4)}, ${userCoords.lng.toFixed(4)} (å·²åŒæ­¥)` : "æ­£åœ¨å–å¾— GPS åº§æ¨™...";
            }
        }

        function updateDistricts() { 
            const city = document.getElementById('city').value; 
            document.getElementById('district').innerHTML = cityData[city].map(d => `<option value="${d}">${d}</option>`).join(''); 
        }

        function getStoredKey() { return localStorage.getItem('EXPLORER_FINAL_SECURE_KEY') || ""; }
        function saveApiKey() { const k = document.getElementById('api-key-input').value.trim(); if(k) { localStorage.setItem('EXPLORER_FINAL_SECURE_KEY', k); document.getElementById('api-overlay').style.display='none'; updateUsageDisplay(); } }
        function getUsageCount() { const key = getStoredKey(); if (!key) return 0; const keyId = "KEY_" + key.slice(-10); return parseInt(localStorage.getItem('COUNT_' + keyId) || '0'); }
        function updateUsageDisplay() { const count = getUsageCount(); document.getElementById('usage-text').innerText = `ä»Šæ—¥å‰©é¤˜æ¬¡æ•¸ï¼š${DAILY_LIMIT - count} æ¬¡`; const btn = document.getElementById('search-btn'); if (count >= DAILY_LIMIT) { btn.disabled = true; btn.innerText = "ä»Šæ—¥æ¬¡æ•¸å·²æ»¿"; } else { btn.disabled = false; btn.innerText = "é–‹å§‹æ¢ç´¢ç¾é£Ÿ"; } }

        // --- æ ¸å¿ƒé‚è¼¯ä¿®æ­£ ---

        async function handleSearchClick() {
            if (!getStoredKey()) { document.getElementById('api-overlay').style.display = 'flex'; return; }
            if (getUsageCount() >= DAILY_LIMIT) { alert("ğŸš« ä»Šæ—¥æ¬¡æ•¸å·²æ»¿ã€‚"); return; }
            startSearch();
        }

        async function startSearch() {
            const loader = document.getElementById('loader');
            const btn = document.getElementById('search-btn');
            const ui = document.getElementById('main-ui');
            if (isNearbyMode && (!userCoords.lat || !userCoords.lng)) { alert("å°šæœªå–å¾—å®šä½ï¼"); return; }
            
            btn.disabled = true; // é€™è£¡æœƒè§¸ç™¼ CSS ä¿®æ­£2ï¼Œé¡è‰²ä¿æŒæ©˜è‰²
            loader.style.display = 'flex';

            try {
                const now = new Date();
                const data = {
                    apiKey: getStoredKey(),
                    city: isNearbyMode ? "" : document.getElementById('city').options[document.getElementById('city').selectedIndex].text,
                    district: isNearbyMode ? "" : document.getElementById('district').value,
                    food: document.getElementById('food').options[document.getElementById('food').selectedIndex].text,
                    purpose: document.getElementById('purpose').options[document.getElementById('purpose').selectedIndex].text,
                    budget: document.getElementById('budget').options[document.getElementById('budget').selectedIndex].text,
                    userTime: `${now.getHours()}:${now.getMinutes()}`,
                    lat: userCoords.lat, lng: userCoords.lng
                };

                const res = await getAiRecommendation(data);
                
                if(res.error) { 
                    alert(res.error); 
                    ui.classList.remove('blur-mode');
                } else if(res.data && res.data.length > 0) {
                    const keyId = "KEY_" + data.apiKey.slice(-10);
                    localStorage.setItem('COUNT_' + keyId, (getUsageCount() + 1).toString());
                    updateUsageDisplay();
                    renderCards(res.data);
                }
            } catch(e) { 
                alert("æœå°‹ç•°å¸¸ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚"); 
                ui.classList.remove('blur-mode');
            } finally { 
                loader.style.display = 'none'; 
                btn.disabled = false; 
            }
        }

        async function getAiRecommendation(req) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${req.apiKey}`;
            
            // ä¿®æ­£ 4: å¼·åŒ–åº§æ¨™æœå°‹ Prompt
            let locationPrompt = "";
            if (isNearbyMode) {
                locationPrompt = `æ ¹æ“šæä¾›çš„ GPS åº§æ¨™ (${req.lat}, ${req.lng})ï¼Œè«‹å…ˆå•Ÿå‹•æœå°‹å·¥å…·ï¼š
                1. è­˜åˆ¥è©²åº§æ¨™æ‰€åœ¨çš„è¡Œæ”¿å€åŠè·¯åã€‚
                2. å°‹æ‰¾è©²åº§æ¨™ 500 å…¬å°ºå…§çš„è‘—ååœ°æ¨™æˆ–äº¤é€šç›®æ¨™ï¼ˆå¦‚ï¼šæ·é‹ç«™å‡ºå£ã€ç™¾è²¨ã€çŸ¥åå…¬åœ’ï¼‰ã€‚
                3. ä»¥åœ°æ¨™ç‚ºæ ¸å¿ƒæœå°‹å‘¨é‚Š 1 å…¬é‡Œå…§ç¬¦åˆæ¢ä»¶çš„åº—å®¶ã€‚`;
            } else {
                locationPrompt = `æœå°‹åœ°å€ç‚ºã€Œ${req.city} ${req.district}ã€ã€‚`;
            }

            const prompt = `ä½ æ˜¯ç¾é£Ÿå°ˆå®¶ã€‚ä»»å‹™å¦‚ä¸‹ï¼š
                ${locationPrompt}
                ç›®æ¨™é¡åˆ¥ï¼šã€Œ${req.food}ã€ã€ç”¨é€”ï¼šã€Œ${req.purpose}ã€ã€é ç®—ï¼šã€Œ${req.budget}ã€ã€‚
                
                è¦ç¯„ï¼š
                - æ‰¾å‡º 5 é–“çœŸå¯¦å­˜åœ¨çš„åº—ã€‚
                - å¿…é ˆè¯ç¶²ç¢ºèªåœ¨å°ç£æ™‚é–“ (${req.userTime}) æ˜¯å¦ç‡Ÿæ¥­ä¸­ã€‚
                - è¼¸å‡ºæ ¼å¼ç‚º JSON é™£åˆ—ï¼Œç¦æ­¢ Markdownã€‚
                - å¿…é ˆåŒ…å« lat, lng æ•¸å­—æ¬„ä½ã€‚

                JSON çµæ§‹ï¼š
                [{ "name":"åº—å", "rating":"è©•åˆ†", "hours":"ç‡Ÿæ¥­æ™‚é–“", "price":"åƒ¹ä½", "signature":"æ¨è–¦å¿…é»", "review_summary":"çŸ­è©•", "address":"åœ°å€", "lat": ç·¯åº¦, "lng": ç¶“åº¦ }]`;

            const requestBody = { contents: [{ parts: [{ text: prompt }] }], tools: [{ google_search: {} }] };

            try {
                const response = await fetch(url, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(requestBody) });
                const result = await response.json();
                let text = result.candidates[0].content.parts[0].text;
                text = text.replace(/\[\d+(,\s*\d+)*\]/g, "").replace(/```json/g, "").replace(/```/g, "").trim();
                const startIdx = text.indexOf('['); const endIdx = text.lastIndexOf(']');
                return { data: JSON.parse(text.substring(startIdx, endIdx + 1)) };
            } catch (e) {
                return { error: "è§£æè³‡æ–™å¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚" };
            }
        }

        function renderCards(restaurants) {
            document.getElementById('main-ui').classList.add('blur-mode');
            const stack = document.getElementById('card-stack'); 
            stack.innerHTML = '';
            document.getElementById('swiper-overlay').style.display = 'flex';
            
            restaurants.forEach((res, index) => {
                const distStr = calculateDistance(userCoords.lat, userCoords.lng, res.lat, res.lng);
                const wrapper = document.createElement('div'); wrapper.className = 'swipe-card-wrapper';
                const card = document.createElement('div'); card.className = 'swipe-card';
                card.innerHTML = `
                    <div class="swipe-hints"><div class="hint-item">â† NOPE</div><div class="hint-item">LIKE â†’</div></div>
                    <div class="swipe-label label-like">LIKE</div><div class="swipe-label label-nope">NOPE</div>
                    <div class="label-chosen">ğŸ† æœ€çµ‚é¦–é¸</div>
                    <h3>${res.name}</h3>
                    <div class="card-badges">
                        <span class="card-badge badge-rating">â­ ${res.rating}</span>
                        <span class="card-badge badge-price">ğŸ’° ${res.price || '---'}</span>
                        <span class="card-badge badge-distance">ğŸ“ ${distStr}</span>
                    </div>
                    <div class="info-row"><span class="info-label">ğŸ•’ ç‡Ÿæ¥­</span><span>${res.hours}</span></div>
                    <div class="info-row"><span class="info-label">ğŸ”¥ æ‹›ç‰Œ</span><span>${res.signature}</span></div>
                    <div class="card-summary">"${res.review_summary}"</div>
                    <a class="card-map-btn" href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(res.name + ' ' + res.address)}" target="_blank">ğŸ—ºï¸ æŸ¥çœ‹åœ°åœ–</a>
                `;
                wrapper.appendChild(card); 
                stack.appendChild(wrapper); 
                // ä¿®æ­£ 3: å‚³å…¥ç´¢å¼•åˆ¤æ–·æ˜¯å¦ç‚ºæœ€å¾Œä¸€å¼µ
                initSwipe(card, wrapper, index === restaurants.length - 1);
            });
            const closeBtn = document.createElement('button');
            closeBtn.className = 'close-swiper'; closeBtn.innerText = 'â† è¿”å›èª¿æ•´'; closeBtn.onclick = resetUI;
            stack.appendChild(closeBtn); 
        }

        function initSwipe(el, wrapper, isLastOne) {
            let startX, moveX = 0;
            const likeLabel = el.querySelector('.label-like'); 
            const nopeLabel = el.querySelector('.label-nope');
            const stamp = el.querySelector('.label-chosen');

            el.addEventListener('touchstart', (e) => { startX = e.touches[0].clientX; el.style.transition = 'none'; });
            el.addEventListener('touchmove', (e) => { 
                moveX = e.touches[0].clientX - startX;
                if(Math.abs(moveX) > 10) {
                    el.style.transform = `translateX(${moveX}px) rotate(${moveX/20}deg)`;
                    likeLabel.style.opacity = moveX > 0 ? Math.min(moveX/100, 1) : 0;
                    nopeLabel.style.opacity = moveX < 0 ? Math.min(Math.abs(moveX)/100, 1) : 0;
                }
            });
            el.addEventListener('touchend', () => { 
                el.style.transition = '0.4s ease'; 
                if (Math.abs(moveX) > 100) { 
                    const dir = moveX > 0 ? 1 : -1;
                    // ä¿®æ­£ 3: æœ€å¾Œä¸€å¼µå¾€å³æ»‘è“‹ç« ï¼Œå¾€å·¦æ»‘æ¶ˆå¤±
                    if (isLastOne && dir === 1) { 
                        el.style.transform = 'translateX(0) rotate(0deg)'; 
                        likeLabel.style.opacity = 0;
                        stamp.classList.add('active'); 
                    } else { 
                        el.style.transform = `translateX(${dir * 150}%)`; 
                        setTimeout(() => { 
                            wrapper.remove(); 
                            if(!document.querySelector('.swipe-card-wrapper')) resetUI(); 
                        }, 300); 
                    }
                } else { 
                    el.style.transform = 'translateX(0) rotate(0deg)'; 
                    likeLabel.style.opacity = 0; nopeLabel.style.opacity = 0; 
                }
            });
        }

        function resetUI() { document.getElementById('swiper-overlay').style.display = 'none'; document.getElementById('main-ui').classList.remove('blur-mode'); }

        window.onload = () => {
            initLocationWatch(); updateDistricts(); updateUsageDisplay();
            const bg = document.getElementById('bg-container'); 
            images.forEach((url, i) => { const div = document.createElement('div'); div.className = 'bg-slide' + (i===0?' active':''); div.style.backgroundImage = `url('${url}?auto=format&fit=crop&w=1200')`; bg.appendChild(div); });
            setInterval(() => { 
                let slides = document.querySelectorAll('.bg-slide');
                let active = document.querySelector('.bg-slide.active');
                if(!active) return;
                let next = active.nextElementSibling || slides[0];
                active.classList.remove('active'); next.classList.add('active');
            }, 6000);
        };
    </script>
</body>
</html>

<script>
    /* --- 1. èƒŒæ™¯èˆ‡åº§æ¨™ --- */
    const images = ['https://images.unsplash.com/photo-1555939594-58d7cb561ad1','https://images.unsplash.com/photo-1594046243098-0fceea9d451e','https://images.unsplash.com/photo-1563245372-f21724e3856d','https://images.unsplash.com/photo-1512621776951-a57141f2eefd','https://images.unsplash.com/photo-1504674900247-0877df9cc836','https://images.unsplash.com/photo-1565299624946-b28f40a0ae38'];
    const bgContainer = document.getElementById('bg-container');
    images.forEach((url, i) => { const div = document.createElement('div'); div.className = 'bg-slide' + (i === 0 ? ' active' : ''); div.style.backgroundImage = `url('${url}?auto=format&fit=crop&w=1200')`; bgContainer.appendChild(div); });
    let slideIdx = 0; setInterval(() => { const slides = document.querySelectorAll('.bg-slide'); if(slides.length){ slides[slideIdx].classList.remove('active'); slideIdx = (slideIdx + 1) % slides.length; slides[slideIdx].classList.add('active'); } }, 6000);
    
    let userCoords = { lat: null, lng: null };
    function initLocation() { if (navigator.geolocation) { navigator.geolocation.watchPosition(p => { userCoords.lat = p.coords.latitude; userCoords.lng = p.coords.longitude; document.getElementById('coords-text').innerText = `ğŸ“ ${userCoords.lat.toFixed(4)}, ${userCoords.lng.toFixed(4)} (å·²åŒæ­¥)`; }, () => { document.getElementById('coords-text').innerText = "ğŸ“ GPS æœªæˆæ¬Š"; }); } }
    initLocation();

    // æ ¸å¿ƒä¿®å¾©ï¼šè·é›¢è¨ˆç®—å‡½æ•¸
    function calculateDistance(lat1, lon1, lat2, lon2) {
        if (!lat1 || !lon1 || !lat2 || !lon2) return "æœªçŸ¥";
        const R = 6371; const dLat = (lat2 - lat1) * Math.PI / 180; const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
        const d = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)) * R;
        return d < 1 ? `${(d * 1000).toFixed(0)}m` : `${d.toFixed(1)}km`;
    }

    /* --- 2. æ•¸æ“šåº«èˆ‡å¸¸æ•¸ --- */
    const DAILY_LIMIT = 15; // æ ¸å¿ƒä¿®å¾©ï¼šå®šç¾©é…é¡ä¸Šé™
    const cityData = { 'Taipei': ['å…¨å€', 'ä¸­æ­£å€', 'å¤§åŒå€', 'ä¸­å±±å€', 'æ¾å±±å€', 'å¤§å®‰å€', 'è¬è¯å€', 'ä¿¡ç¾©å€', 'å£«æ—å€', 'åŒ—æŠ•å€', 'å…§æ¹–å€', 'å—æ¸¯å€', 'æ–‡å±±å€'], 'NewTaipei': ['å…¨å€', 'æ¿æ©‹å€', 'ä¸‰é‡å€', 'ä¸­å’Œå€', 'æ°¸å’Œå€', 'æ–°èŠå€', 'æ–°åº—å€', 'åœŸåŸå€', 'è˜†æ´²å€', 'æ¨¹æ—å€', 'é¶¯æ­Œå€', 'ä¸‰å³½å€', 'æ·¡æ°´å€', 'æ±æ­¢å€', 'ç‘èŠ³å€', 'äº”è‚¡å€', 'æ³°å±±å€', 'æ—å£å€', 'æ·±å‘å€', 'çŸ³ç¢‡å€', 'åªæ—å€', 'ä¸‰èŠå€', 'çŸ³é–€å€', 'å…«é‡Œå€', 'å¹³æºªå€', 'é›™æºªå€', 'è²¢å¯®å€', 'é‡‘å±±å€', 'è¬é‡Œå€', 'çƒä¾†å€'], 'Keelung': ['å…¨å€', 'ä»æ„›å€', 'ä¿¡ç¾©å€', 'ä¸­æ­£å€', 'ä¸­å±±å€', 'å®‰æ¨‚å€', 'æš–æš–å€', 'ä¸ƒå µå€'], 'Taoyuan': ['å…¨å€', 'æ¡ƒåœ’å€', 'ä¸­å£¢å€', 'å¹³é®å€', 'å…«å¾·å€', 'æ¥Šæ¢…å€', 'è˜†ç«¹å€', 'å¤§æºªå€', 'é¾æ½­å€', 'é¾œå±±å€', 'å¤§åœ’å€', 'è§€éŸ³å€', 'æ–°å±‹å€', 'å¾©èˆˆå€'], 'HsinchuCity': ['å…¨å€', 'æ±å€', 'åŒ—å€', 'é¦™å±±å€'], 'HsinchuCounty': ['å…¨å€', 'ç«¹åŒ—å¸‚', 'ç«¹æ±é®', 'æ–°åŸ”é®', 'é—œè¥¿é®', 'æ¹–å£é„‰', 'æ–°è±é„‰', 'å³¨çœ‰é„‰', 'å¯¶å±±é„‰', 'åŒ—åŸ”é„‰', 'æ©«å±±é„‰', 'èŠæ—é„‰', 'å°–çŸ³é„‰', 'äº”å³°é„‰'], 'Yilan': ['å…¨å€', 'å®œè˜­å¸‚', 'ç¾…æ±é®', 'è˜‡æ¾³é®', 'é ­åŸé®', 'ç¤æºªé„‰', 'å£¯åœé„‰', 'å“¡å±±é„‰', 'å†¬å±±é„‰', 'äº”çµé„‰', 'ä¸‰æ˜Ÿé„‰', 'å¤§åŒé„‰', 'å—æ¾³é„‰'], 'Miaoli': ['å…¨å€', 'è‹—æ —å¸‚', 'é ­ä»½å¸‚', 'ç«¹å—é®', 'å¾Œé¾é®', 'é€šéœ„é®', 'è‹‘è£¡é®', 'å“è˜­é®', 'é€ æ©‹é„‰', 'è¥¿æ¹–é„‰', 'é ­å±‹é„‰', 'å…¬é¤¨é„‰', 'éŠ…é‘¼é„‰', 'ä¸‰ç¾©é„‰', 'å¤§æ¹–é„‰', 'ç…æ½­é„‰', 'ä¸‰ç£é„‰', 'å—åº„é„‰', 'æ³°å®‰é„‰'], 'Taichung': ['å…¨å€', 'ä¸­å€', 'æ±å€', 'å—å€', 'è¥¿å€', 'åŒ—å€', 'åŒ—å±¯å€', 'è¥¿å±¯å€', 'å—å±¯å€', 'å¤ªå¹³å€', 'å¤§é‡Œå€', 'éœ§å³°å€', 'çƒæ—¥å€', 'è±åŸå€', 'å¾Œé‡Œå€', 'çŸ³å²¡å€', 'æ±å‹¢å€', 'å’Œå¹³å€', 'æ–°ç¤¾å€', 'æ½­å­å€', 'å¤§é›…å€', 'ç¥å²¡å€', 'å¤§è‚šå€', 'é¾äº•å€', 'æ¢§æ£²å€', 'æ¸…æ°´å€', 'å¤§ç”²å€', 'å¤–åŸ”å€', 'å¤§å®‰å€'], 'Changhua': ['å…¨å€', 'å½°åŒ–å¸‚', 'å“¡æ—å¸‚', 'å’Œç¾é®', 'é¹¿æ¸¯é®', 'æºªæ¹–é®', 'äºŒæ—é®', 'ç”°ä¸­é®', 'åŒ—æ–—é®', 'èŠ±å£‡é„‰', 'èŠ¬åœ’é„‰', 'å¤§æ‘é„‰', 'æ°¸é–é„‰', 'ä¼¸æ¸¯é„‰', 'ç·šè¥¿é„‰', 'ç¦èˆˆé„‰', 'ç§€æ°´é„‰', 'åŸ”å¿ƒé„‰', 'åŸ”é¹½é„‰', 'å¤§åŸé„‰', 'èŠ³è‹‘é„‰', 'ç«¹å¡˜é„‰', 'ç¤¾é ­é„‰', 'äºŒæ°´é„‰', 'æºªå·é„‰', 'ç”°å°¾é„‰', 'åŸ¤é ­é„‰'], 'Nantou': ['å…¨å€', 'å—æŠ•å¸‚', 'åŸ”é‡Œé®', 'è‰å±¯é®', 'ç«¹å±±é®', 'é›†é›†é®', 'åé–“é„‰', 'é¹¿è°·é„‰', 'ä¸­å¯®é„‰', 'é­šæ± é„‰', 'åœ‹å§“é„‰', 'æ°´é‡Œé„‰', 'ä¿¡ç¾©é„‰', 'ä»æ„›é„‰'], 'Yunlin': ['å…¨å€', 'æ–—å…­å¸‚', 'æ–—å—é®', 'è™å°¾é®', 'è¥¿èºé®', 'åœŸåº«é®', 'åŒ—æ¸¯é®', 'å¤å‘é„‰', 'å¤§åŸ¤é„‰', 'è¿æ¡é„‰', 'æ—å…§é„‰', 'äºŒå´™é„‰', 'å´™èƒŒé„‰', 'éº¥å¯®é„‰', 'æ±å‹¢é„‰', 'è¤’å¿ é„‰', 'å°è¥¿é„‰', 'å…ƒé•·é„‰', 'å››æ¹–é„‰', 'å£æ¹–é„‰', 'æ°´æ—é„‰'], 'ChiayiCity': ['å…¨å€', 'æ±å€', 'è¥¿å€'], 'ChiayiCounty': ['å…¨å€', 'å¤ªä¿å¸‚', 'æœ´å­å¸‚', 'å¸ƒè¢‹é®', 'å¤§æ—é®', 'æ°‘é›„é„‰', 'æºªå£é„‰', 'æ–°æ¸¯é„‰', 'å…­è…³é„‰', 'æ±çŸ³é„‰', 'ç¾©ç«¹é„‰', 'é¹¿è‰é„‰', 'æ°´ä¸Šé„‰', 'ä¸­åŸ”é„‰', 'ç«¹å´é„‰', 'æ¢…å±±é„‰', 'ç•ªè·¯é„‰', 'å¤§åŸ”é„‰', 'é˜¿é‡Œå±±é„‰'], 'Tainan': ['å…¨å€', 'ä¸­è¥¿å€', 'æ±å€', 'å—å€', 'åŒ—å€', 'å®‰å¹³å€', 'å®‰å—å€', 'æ°¸åº·å€', 'æ­¸ä»å€', 'æ–°åŒ–å€', 'ç‰äº•å€', 'ä»å¾·å€', 'é—œå»Ÿå€', 'å®˜ç”°å€', 'éº»è±†å€', 'ä½³é‡Œå€', 'æ–°ç‡Ÿå€', 'å–„åŒ–å€'], 'Kaohsiung': ['å…¨å€', 'æ¥ æ¢“å€', 'å·¦ç‡Ÿå€', 'é¼“å±±å€', 'ä¸‰æ°‘å€', 'é¹½åŸ•å€', 'å‰é‡‘å€', 'æ–°èˆˆå€', 'è‹“é›…å€', 'å‰é®å€', 'æ——æ´¥å€', 'å°æ¸¯å€', 'é³³å±±å€', 'å¤§å¯®å€', 'é³¥æ¾å€', 'æ—åœ’å€', 'ä»æ­¦å€', 'å¤§æ¨¹å€', 'å¤§ç¤¾å€', 'å²¡å±±å€', 'è·¯ç«¹å€', 'æ——å±±å€', 'ç¾æ¿ƒå€'], 'Pingtung': ['å…¨å€', 'å±æ±å¸‚', 'æ½®å·é®', 'æ±æ¸¯é®', 'æ†æ˜¥é®', 'è¬ä¸¹é„‰', 'é•·æ²»é„‰', 'é‡Œæ¸¯é„‰', 'å…§åŸ”é„‰', 'æ‹å¯®é„‰', 'è»ŠåŸé„‰'], 'Hualien': ['å…¨å€', 'èŠ±è“®å¸‚', 'é³³æ—é®', 'ç‰é‡Œé®', 'æ–°åŸé„‰', 'å‰å®‰é„‰', 'å£½è±é„‰', 'å…‰å¾©é„‰', 'ç‘ç©—é„‰'], 'Taitung': ['å…¨å€', 'å°æ±å¸‚', 'æˆåŠŸé®', 'é—œå±±é®', 'å‘å—é„‰', 'é¹¿é‡é„‰', 'æ± ä¸Šé„‰', 'ç¶ å³¶é„‰', 'è˜­å¶¼é„‰'], 'Penghu': ['å…¨å€', 'é¦¬å…¬å¸‚', 'æ¹–è¥¿é„‰', 'ç™½æ²™é„‰', 'è¥¿å¶¼é„‰'], 'Kinmen': ['å…¨å€', 'é‡‘åŸé®', 'é‡‘æ¹–é®', 'é‡‘æ²™é®', 'é‡‘å¯§é„‰'], 'Lienchiang': ['å…¨å€', 'å—ç«¿é„‰', 'åŒ—ç«¿é„‰', 'è’å…‰é„‰', 'æ±å¼•é„‰'] };
    const mrtLinesTaipei = { 'æ¿å—ç·š (BL)': ['é¾å±±å¯º', 'è¥¿é–€', 'å°åŒ—è»Šç«™', 'å–„å°å¯º', 'å¿ å­æ–°ç”Ÿ', 'å¿ å­å¾©èˆˆ', 'å¿ å­æ•¦åŒ–', 'åœ‹çˆ¶ç´€å¿µé¤¨', 'å¸‚æ”¿åºœ', 'æ°¸æ˜¥', 'å¾Œå±±åŸ¤', 'æ˜†é™½', 'å—æ¸¯', 'å—æ¸¯å±•è¦½é¤¨'], 'æ·¡æ°´ä¿¡ç¾©ç·š (R)': ['è±¡å±±', 'å°åŒ—101/ä¸–è²¿', 'ä¿¡ç¾©å®‰å’Œ', 'å¤§å®‰', 'å¤§å®‰æ£®æ—å…¬åœ’', 'æ±é–€', 'ä¸­æ­£ç´€å¿µå ‚', 'å°å¤§é†«é™¢', 'å°åŒ—è»Šç«™', 'ä¸­å±±', 'é›™é€£', 'æ°‘æ¬Šè¥¿è·¯', 'åœ“å±±', 'åŠæ½­', 'å£«æ—', 'èŠå±±', 'æ˜å¾·', 'çŸ³ç‰Œ', 'å”­å“©å²¸', 'å¥‡å²©', 'åŒ—æŠ•', 'æ–°åŒ—æŠ•', 'å¾©èˆˆå´—', 'å¿ ç¾©', 'é—œæ¸¡', 'ç«¹åœ', 'ç´…æ¨¹æ—', 'æ·¡æ°´'], 'æ¾å±±æ–°åº—ç·š (G)': ['æ™¯ç¾', 'è¬éš†', 'å…¬é¤¨', 'å°é›»å¤§æ¨“', 'å¤äº­', 'ä¸­æ­£ç´€å¿µå ‚', 'å°å—é–€', 'è¥¿é–€', 'åŒ—é–€', 'ä¸­å±±', 'æ¾æ±Ÿå—äº¬', 'å—äº¬å¾©èˆˆ', 'å°åŒ—å°å·¨è›‹', 'å—äº¬ä¸‰æ°‘', 'æ¾å±±'], 'ä¸­å’Œæ–°è˜†ç·š (O)': ['å¤äº­', 'æ±é–€', 'å¿ å­æ–°ç”Ÿ', 'æ¾æ±Ÿå—äº¬', 'è¡Œå¤©å®®', 'ä¸­å±±åœ‹å°', 'æ°‘æ¬Šè¥¿è·¯', 'å¤§æ©‹é ­'], 'æ–‡æ¹–ç·š (BR)': ['å‹•ç‰©åœ’', 'æœ¨æŸµ', 'è¬èŠ³ç¤¾å€', 'è¬èŠ³é†«é™¢', 'è¾›äº¥', 'éºŸå…‰', 'å…­å¼µçŠ', 'ç§‘æŠ€å¤§æ¨“', 'å¤§å®‰', 'å¿ å­å¾©èˆˆ', 'å—äº¬å¾©èˆˆ', 'ä¸­å±±åœ‹ä¸­', 'æ¾å±±æ©Ÿå ´', 'å¤§ç›´', 'åŠå—è·¯', 'è¥¿æ¹–', 'æ¸¯å¢˜', 'æ–‡å¾·', 'å…§æ¹–', 'å¤§æ¹–å…¬åœ’', 'è‘«æ´²', 'æ±æ¹–', 'å—æ¸¯è»Ÿé«”åœ’å€', 'å—æ¸¯å±•è¦½é¤¨'] };
    const mrtLinesNewTaipei = { 'æ¿å—ç·š (BL)': ['é ‚åŸ”', 'æ°¸å¯§', 'åœŸåŸ', 'æµ·å±±', 'äºæ±é†«é™¢', 'åºœä¸­', 'æ¿æ©‹', 'æ–°åŸ”', 'æ±Ÿå­ç¿ '], 'æ·¡æ°´ä¿¡ç¾©ç·š (R)': ['ç«¹åœ', 'ç´…æ¨¹æ—', 'æ·¡æ°´'], 'æ¾å±±æ–°åº—ç·š (G)': ['æ–°åº—', 'æ–°åº—å€å…¬æ‰€', 'ä¸ƒå¼µ', 'å¤§åªæ—'], 'ä¸­å’Œæ–°è˜†ç·š (O)': ['å—å‹¢è§’', 'æ™¯å®‰', 'æ°¸å®‰å¸‚å ´', 'é ‚æºª', 'ä¸‰é‡åœ‹å°', 'ä¸‰å’Œåœ‹ä¸­', 'å¾åŒ¯ä¸­å­¸', 'ä¸‰æ°‘é«˜ä¸­', 'è˜†æ´²', 'å°åŒ—æ©‹', 'èœå¯®', 'ä¸‰é‡', 'å…ˆå—‡å®®', 'é ­å‰åº„', 'æ–°èŠ', 'è¼”å¤§', 'ä¸¹é³³', 'è¿´é¾'], 'ç’°ç‹€ç·š (Y)': ['å¤§åªæ—', 'åå››å¼µ', 'ç§€æœ—æ©‹', 'æ™¯å¹³', 'æ™¯å®‰', 'ä¸­å’Œ', 'æ©‹å’Œ', 'ä¸­åŸ', 'æ¿æ–°', 'æ¿æ©‹', 'æ–°åŸ”æ°‘ç”Ÿ', 'é ­å‰åº„', 'å¹¸ç¦', 'æ–°åŒ—ç”¢æ¥­åœ’å€'] };
    const mrtLinesTaoyuan = { 'æ©Ÿå ´æ·é‹ (A)': ['å°åŒ—è»Šç«™', 'ä¸‰é‡', 'æ©Ÿå ´ç¬¬ä¸€èˆªå»ˆ', 'æ©Ÿå ´ç¬¬äºŒèˆªå»ˆ', 'é«˜éµæ¡ƒåœ’ç«™', 'è€è¡—æºª'] };
    const mrtLinesTaichung = { 'ç¶ ç·š': ['åŒ—å±¯ç¸½ç«™', 'æ¾ç«¹', 'å¸‚æ”¿åºœ', 'å¤§æ…¶', 'é«˜éµå°ä¸­ç«™'] };
    const mrtLinesKaohsiung = { 'ç´…ç·š (R)': ['å°æ¸¯', 'é«˜é›„åœ‹éš›æ©Ÿå ´', 'ä¸‰å¤šå•†åœˆ', 'ä¸­å¤®å…¬åœ’', 'ç¾éº—å³¶', 'é«˜é›„è»Šç«™', 'å·¨è›‹', 'å·¦ç‡Ÿ', 'æ©‹é ­è»Šç«™', 'å²¡å±±è»Šç«™'], 'æ©˜ç·š (O)': ['å“ˆç‘ªæ˜Ÿ', 'é¹½åŸ•åŸ”', 'ç¾éº—å³¶', 'è¡›æ­¦ç‡Ÿ', 'é³³å±±', 'å¤§å¯®'] };
    const mrtMap = { 'Taipei': { 'ä¸­æ­£å€': ['å°åŒ—è»Šç«™', 'å–„å°å¯º', 'å¿ å­æ–°ç”Ÿ', 'ä¸­æ­£ç´€å¿µå ‚', 'å¤äº­', 'è¥¿é–€', 'å°å¤§é†«é™¢'], 'è¬è¯å€': ['è¥¿é–€', 'é¾å±±å¯º'], 'å¤§å®‰å€': ['å¿ å­å¾©èˆˆ', 'å¿ å­æ•¦åŒ–', 'åœ‹çˆ¶ç´€å¿µé¤¨', 'ä¿¡ç¾©å®‰å’Œ', 'å¤§å®‰', 'ç§‘æŠ€å¤§æ¨“', 'å…­å¼µçŠ', 'å…¬é¤¨', 'æ±é–€'], 'ä¿¡ç¾©å€': ['å¸‚æ”¿åºœ', 'æ°¸æ˜¥', 'å¾Œå±±åŸ¤', 'è±¡å±±', 'å°åŒ—101/ä¸–è²¿'], 'ä¸­å±±å€': ['ä¸­å±±', 'é›™é€£', 'æ°‘æ¬Šè¥¿è·¯', 'åœ“å±±', 'æ¾æ±Ÿå—äº¬', 'è¡Œå¤©å®®', 'ä¸­å±±åœ‹å°', 'å¤§ç›´', 'åŠå—è·¯'], 'æ¾å±±å€': ['å—äº¬å¾©èˆˆ', 'å°åŒ—å°å·¨è›‹', 'å—äº¬ä¸‰ä¸‰æ°‘', 'æ¾å±±'], 'å¤§åŒå€': ['å¤§æ©‹é ­', 'ä¸­å±±', 'åœ“å±±', 'æ°‘æ¬Šè¥¿è·¯'], 'å£«æ—å€': ['åŠæ½­', 'å£«æ—', 'èŠå±±', 'æ˜å¾·'], 'åŒ—æŠ•å€': ['çŸ³ç‰Œ', 'å”­å“©å²¸', 'å¥‡å²©', 'åŒ—æŠ•', 'æ–°åŒ—æŠ•', 'å¾©èˆˆå´—', 'é—œæ¸¡'], 'å…§æ¹–å€': ['è¥¿æ¹–', 'æ¸¯å¢˜', 'æ–‡å¾·', 'å…§æ¹–', 'å¤§æ¹–å…¬åœ’', 'è‘«æ´²', 'æ±æ¹–'], 'å—æ¸¯å€': ['å—æ¸¯', 'å—æ¸¯å±•è¦½é¤¨', 'å—æ¸¯è»Ÿé«”åœ’å€', 'æ˜†é™½'], 'æ–‡å±±å€': ['å‹•ç‰©åœ’', 'æœ¨æŸµ', 'è¬èŠ³é†«é™¢', 'è¬èŠ³ç¤¾å€', 'æ™¯ç¾', 'è¬éš†'] }, 'NewTaipei': { 'æ¿æ©‹å€': ['æ¿æ©‹', 'åºœä¸­', 'æ–°åŸ”', 'æ±Ÿå­ç¿ ', 'äºæ±é†«é™¢'], 'ä¸‰é‡å€': ['ä¸‰é‡', 'èœå¯®', 'å°åŒ—æ©‹', 'ä¸‰é‡åœ‹å°', 'ä¸‰å’Œåœ‹ä¸­', 'å¾åŒ¯ä¸­å­¸'], 'ä¸­å’Œå€': ['æ™¯å®‰', 'å—å‹¢è§’', 'æ°¸å®‰å¸‚å ´', 'ä¸­å’Œ'], 'æ°¸å’Œå€': ['é ‚æºª', 'æ°¸å®‰å¸‚å ´'], 'æ–°èŠå€': ['æ–°èŠ', 'è¼”å¤§', 'ä¸¹é³³', 'è¿´é¾', 'é ­å‰åº„'], 'æ–°åº—å€': ['æ–°åº—', 'ä¸ƒå¼µ', 'å¤§åªæ—', 'å°ç¢§æ½­', 'æ–°åº—å€å…¬æ‰€'], 'æ·¡æ°´å€': ['æ·¡æ°´', 'ç´…æ¨¹æ—', 'ç«¹åœ'], 'æ—å£å€': ['æ—å£'] } };
    const trainMap = { 'Keelung': { 'ä»æ„›å€': ['åŸºéš†'], 'æš–æš–å€': ['æš–æš–', 'å…«å µ'], 'ä¸ƒå µå€': ['ä¸ƒå µ', 'ç™¾ç¦'] }, 'Taipei': { 'ä¸­æ­£å€': ['å°åŒ—'], 'è¬è¯å€': ['è¬è¯'], 'æ¾å±±å€': ['æ¾å±±'], 'å—æ¸¯å€': ['å—æ¸¯'] }, 'NewTaipei': { 'æ¿æ©‹å€': ['æ¿æ©‹', 'æµ®æ´²'], 'æ±æ­¢å€': ['æ±æ­¢', 'æ±ç§‘', 'äº”å µ'], 'æ¨¹æ—å€': ['æ¨¹æ—', 'å—æ¨¹æ—', 'å±±ä½³'], 'é¶¯æ­Œå€': ['é¶¯æ­Œ'], 'ç‘èŠ³å€': ['ç‘èŠ³', 'çŒ´ç¡', 'ä¸‰è²‚å¶º'], 'è²¢å¯®å€': ['ç¦éš†', 'è²¢å¯®'], 'é›™æºªå€': ['é›™æºª'] }, 'Taoyuan': { 'æ¡ƒåœ’å€': ['æ¡ƒåœ’'], 'ä¸­å£¢å€': ['ä¸­å£¢', 'å…§å£¢'], 'æ¥Šæ¢…å€': ['æ¥Šæ¢…', 'åŸ”å¿ƒ', 'å¯Œå²¡'], 'å…«å¾·å€': ['å…§å£¢'] }, 'HsinchuCity': { 'æ±å€': ['æ–°ç«¹', 'æ–°èŠ', 'åƒç”²'], 'åŒ—å€': ['åŒ—æ–°ç«¹'] }, 'HsinchuCounty': { 'ç«¹åŒ—å¸‚': ['ç«¹åŒ—'], 'ç«¹æ±é®': ['ç«¹æ±'], 'æ¹–å£é„‰': ['æ¹–å£', 'æ–°è±'] }, 'Miaoli': { 'è‹—æ —å¸‚': ['è‹—æ —'], 'ç«¹å—é®': ['ç«¹å—'], 'å¾Œé¾é®': ['å¾Œé¾', 'è±å¯Œ'], 'é€šéœ„é®': ['é€šéœ„'], 'è‹‘è£¡é®': ['è‹‘è£¡'], 'ä¸‰ç¾©é„‰': ['ä¸‰ç¾©'] }, 'Taichung': { 'ä¸­å€': ['å°ä¸­'], 'å—å€': ['å¤§æ…¶', 'äº”æ¬Š'], 'è±åŸå€': ['è±åŸ'], 'åé‡Œå€': ['åé‡Œ', 'æ³°å®‰'], 'çƒæ—¥å€': ['çƒæ—¥', 'æ–°çƒæ—¥', 'æˆåŠŸ'], 'æ½­å­å€': ['æ½­å­'], 'æ²™é¹¿å€': ['æ²™é¹¿'], 'æ¸…æ°´å€': ['æ¸…æ°´'], 'å¤§ç”²å€': ['å¤§ç”²'] }, 'Changhua': { 'å½°åŒ–å¸‚': ['å½°åŒ–'], 'å“¡æ—å¸‚': ['å“¡æ—'], 'äºŒæ°´é„‰': ['äºŒæ°´'], 'ç”°ä¸­é®': ['ç”°ä¸­'], 'èŠ±å£‡é„‰': ['èŠ±å£‡'] }, 'Yunlin': { 'æ–—å…­å¸‚': ['æ–—å…­'], 'æ–—å—é®': ['æ–—å—'], 'æ—å…§é„‰': ['æ—å…§'] }, 'ChiayiCity': { 'å˜‰ç¾©': ['å˜‰ç¾©'] }, 'ChiayiCounty': { 'æ°‘é›„é„‰': ['æ°‘é›„'], 'æ°´ä¸Šé„‰': ['æ°´ä¸Š'], 'å¤§æ—é®': ['å¤§æ—'] }, 'Tainan': { 'æ±å€': ['å°å—'], 'æ°¸åº·å€': ['æ°¸åº·', 'å¤§æ©‹'], 'æ–°ç‡Ÿå€': ['æ–°ç‡Ÿ'], 'ä»å¾·å€': ['ä¿å®‰', 'ä»å¾·'], 'å–„åŒ–å€': ['å–„åŒ–'] }, 'Kaohsiung': { 'ä¸‰æ°‘å€': ['é«˜é›„'], 'å·¦ç‡Ÿå€': ['æ–°å·¦ç‡Ÿ', 'å·¦ç‡Ÿ'], 'é¼“å±±å€': ['é¼“å±±', 'ç¾è¡“é¤¨'], 'é³³å±±å€': ['é³³å±±'], 'å²¡å±±å€': ['å²¡å±±'], 'æ¥ æ¢“å€': ['æ¥ æ¢“'] }, 'Pingtung': { 'å±æ±å¸‚': ['å±æ±'], 'æ½®å·é®': ['æ½®å·'], 'æ‹å¯®é„‰': ['æ‹å¯®'], 'æ—é‚Šé„‰': ['æ—é‚Š'] }, 'Yilan': { 'å®œè˜­å¸‚': ['å®œè˜­'], 'ç¾…æ±é®': ['ç¾…æ±'], 'ç¤æºªé„‰': ['ç¤æºª'], 'é ­åŸé®': ['é ­åŸ'], 'è˜‡æ¾³é®': ['è˜‡æ¾³', 'è˜‡æ¾³æ–°'] }, 'Hualien': { 'èŠ±è“®å¸‚': ['èŠ±è“®'], 'ç‰é‡Œé®': ['ç‰é‡Œ'], 'æ–°åŸé„‰': ['æ–°åŸ'], 'å‰å®‰é„‰': ['å‰å®‰'], 'å…‰å¾©é„‰': ['å…‰å¾©'] }, 'Taitung': { 'å°æ±å¸‚': ['å°æ±'], 'é—œå±±é®': ['é—œå±±'], 'æ± ä¸Šé„‰': ['æ± ä¸Š'], 'å‘å—é„‰': ['çŸ¥æœ¬'] } };
    const airportMap = { 'Taipei': { 'æ¾å±±å€': ['å°åŒ—æ¾å±±æ©Ÿå ´'] }, 'Taoyuan': { 'å¤§åœ’å€': ['æ¡ƒåœ’åœ‹éš›æ©Ÿå ´'] }, 'Taichung': { 'æ²™é¹¿å€': ['å°ä¸­åœ‹éš›æ©Ÿå ´'] }, 'Kaohsiung': { 'å°æ¸¯å€': ['é«˜é›„å°æ¸¯æ©Ÿå ´'] }, 'Penghu': { 'æ¹–è¥¿é„‰': ['æ¾æ¹–æ©Ÿå ´'] }, 'Kinmen': { 'é‡‘æ¹–é®': ['é‡‘é–€æ©Ÿå ´'] }, 'Lienchiang': { 'å—ç«¿é„‰': ['é¦¬ç¥–å—ç«¿æ©Ÿå ´'] }, 'Taitung': { 'å°æ±å¸‚': ['å°æ±æ©Ÿå ´'] } };
    const hsrMap = { 'Taipei': { 'ä¸­æ­£å€': ['é«˜éµå°åŒ—ç«™'], 'å—æ¸¯å€': ['é«˜éµå—æ¸¯ç«™'] }, 'NewTaipei': { 'æ¿æ©‹å€': ['é«˜éµæ¿æ©‹ç«™'] }, 'Taoyuan': { 'ä¸­å£¢å€': ['é«˜éµæ¡ƒåœ’ç«™'] }, 'HsinchuCounty': { 'ç«¹åŒ—å¸‚': ['é«˜éµæ–°ç«¹ç«™'] }, 'Miaoli': { 'å¾Œé¾é®': ['é«˜éµè‹—æ —ç«™'] }, 'Taichung': { 'çƒæ—¥å€': ['é«˜éµå°ä¸­ç«™'] }, 'Changhua': { 'ç”°ä¸­é®': ['é«˜éµå½°åŒ–ç«™'] }, 'Yunlin': { 'è™å°¾é®': ['é«˜éµé›²æ—ç«™'] }, 'ChiayiCounty': { 'å¤ªä¿å¸‚': ['é«˜éµå˜‰ç¾©ç«™'] }, 'Tainan': { 'æ­¸ä»å€': ['é«˜éµå°å—ç«™'] }, 'Kaohsiung': { 'å·¦ç‡Ÿå€': ['é«˜éµå·¦ç‡Ÿç«™'] } };

    /* --- 3. AI é‚è¼¯æ ¸å¿ƒ (ä¿®å¾©ç‰ˆ) --- */
    function getStoredKey() { return localStorage.getItem('EXPLORER_FINAL_SECURE_KEY') || ""; }
    function saveApiKey() { const key = document.getElementById('api-key-input').value.trim(); if (key) { localStorage.setItem('EXPLORER_FINAL_SECURE_KEY', key); document.getElementById('api-overlay').style.display = 'none'; refreshUsage(); } }
    
    function refreshUsage() { 
        const key = getStoredKey(); 
        const info = getUsageInfo(key); 
        document.getElementById('usage-text').innerText = `ä»Šæ—¥å‰©é¤˜æ¬¡æ•¸ï¼š${info.remaining} æ¬¡`; 
    }
    
    function getUsageInfo(userApiKey) { 
        if (!userApiKey) return { remaining: 0 }; 
        const keyId = "KEY_" + userApiKey.slice(-10); 
        const today = new Date().toLocaleDateString("zh-TW"); 
        if (localStorage.getItem('DATE_' + keyId) !== today) { localStorage.setItem('DATE_' + keyId, today); localStorage.setItem('COUNT_' + keyId, '0'); } 
        let used = parseInt(localStorage.getItem('COUNT_' + keyId) || '0');
        return { remaining: Math.max(0, DAILY_LIMIT - used), used: used }; 
    }

    async function getAiRecommendation(requestData) {
        const { userApiKey, city, district, food, purpose, budget, people, filters, userTime, mrtStation } = requestData;
        // éµå®ˆè¦æ±‚ï¼šä½¿ç”¨ gemini-2.5-flash
        const url = `https://generativelanguage.googleapis.com/v1/models/gemini-2.5-flash:generateContent?key=${userApiKey}`;
        
        let distPrompt = mrtStation ? `ã€åœ°é»å¿…é ˆåœ¨ã€Œ${mrtStation}ã€ç«™æ­¥è¡Œ 500 å…¬å°ºå…§ã€‚ã€‘` : `ã€ç¯„åœï¼š${city}${district}ã€‘`;
        const prompt = `ä½ æ˜¯ä¸€ä½ç¾é£Ÿå°ˆå®¶ã€‚åœ°é»ï¼š${city}${district} ${mrtStation ? '(é„°è¿‘'+mrtStation+'ç«™)' : ''}ã€‚éœ€æ±‚ï¼š${food} / ${purpose} / é ç®—${budget}ã€‚
        ${distPrompt} 
        å¿…é ˆå›å‚³ 5 é–“çœŸå¯¦å­˜åœ¨çš„åº—ã€‚
        å›å‚³ JSON æ ¼å¼é™£åˆ—ï¼š[{ "name":"", "rating":"", "hours":"", "price":"", "signature":"", "review_summary":"", "reason":"", "map_query":"", "lat":0.0, "lng":0.0 }]`;

        try {
            const response = await fetch(url, { 
                method: "POST", 
                headers: { "Content-Type": "application/json" }, 
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) 
            });
            const result = await response.json();
            const text = result.candidates[0].content.parts[0].text;
            
            // æ ¸å¿ƒä¿®å¾©ï¼šæ›´å¼·å¤§çš„ JSON æå–
            const jsonMatch = text.match(/\[[\s\S]*\]/);
            if (!jsonMatch) throw new Error("Format error");
            const parsedData = JSON.parse(jsonMatch[0]);
            
            const keyId = "KEY_" + userApiKey.slice(-10);
            const currentUsed = parseInt(localStorage.getItem('COUNT_' + keyId) || '0');
            localStorage.setItem('COUNT_' + keyId, (currentUsed + 1).toString());
            
            return { data: parsedData, newRemaining: DAILY_LIMIT - (currentUsed + 1) };
        } catch (e) { 
            console.error(e);
            return { data: [] }; 
        }
    }

    /* --- 4. UI äº’å‹•é‚è¼¯ --- */
    function updateDistricts() { 
        const city = document.getElementById('city').value; 
        const distSelect = document.getElementById('district'); 
        distSelect.innerHTML = cityData[city].map(d => `<option value="${d}">${d}</option>`).join(''); 
        checkTransAvailability();
    }
    window.onload = () => { updateDistricts(); refreshUsage(); };

    function checkTransAvailability() {
        const city = document.getElementById('city').value;
        const transport = document.getElementById('transport').value;
        const district = document.getElementById('district').value;
        const mrtSec = document.getElementById('mrt-section');
        const mrtSel = document.getElementById('mrt-station');
        const label = document.getElementById('trans-label');
        
        if (transport === 'none') { mrtSec.style.display = 'none'; return; }
        mrtSec.style.display = 'block';
        
        if (transport === 'mrt') {
            label.innerText = "ğŸš‡ æŒ‡å®šæ·é‹ç«™";
            let linesData = (city === 'Taipei' ? mrtLinesTaipei : (city === 'NewTaipei' ? mrtLinesNewTaipei : (city === 'Taoyuan' ? mrtLinesTaoyuan : (city === 'Taichung' ? mrtLinesTaichung : (city === 'Kaohsiung' ? mrtLinesKaohsiung : null)))));
            if (district === 'å…¨å€' && linesData) {
                let html = '<option value="">--- è«‹é¸æ“‡ ---</option>';
                for (const line in linesData) { html += `<optgroup label="${line}">`; linesData[line].forEach(s => html += `<option value="${s}">${s}ç«™</option>`); html += `</optgroup>`; }
                mrtSel.innerHTML = html;
            } else if (mrtMap[city] && mrtMap[city][district]) {
                mrtSel.innerHTML = '<option value="">--- è«‹é¸æ“‡ ---</option>' + mrtMap[city][district].map(s => `<option value="${s}">${s}ç«™</option>`).join('');
            } else { mrtSel.innerHTML = '<option value="">æš«ç„¡æ·é‹ç«™</option>'; }
        } else {
            let currentMap = (transport === 'train' ? trainMap : (transport === 'hsr' ? hsrMap : airportMap));
            label.innerText = `ğŸš‰ æŒ‡å®šç«™é»`;
            if (currentMap[city]) {
                let list = (district === 'å…¨å€' ? Object.values(currentMap[city]).flat() : (currentMap[city][district] || []));
                mrtSel.innerHTML = '<option value="">--- è«‹é¸æ“‡ ---</option>' + [...new Set(list)].sort().map(s => `<option value="${s}">${s}</option>`).join('');
            } else { mrtSel.innerHTML = '<option value="">æš«ç„¡ç«™é»</option>'; }
        }
    }

    async function handleSearchClick() {
        const key = getStoredKey();
        if (!key) { document.getElementById('api-overlay').style.display = 'flex'; return; }
        
        const info = getUsageInfo(key);
        if (info.remaining <= 0) { alert("ä»Šæ—¥ 15 æ¬¡é…é¡å·²ç”¨å®Œï¼Œè«‹æ˜å¤©å†è©¦ï¼"); return; }
        
        startSearch(key);
    }

    async function startSearch(userApiKey) {
        const btn = document.getElementById('search-btn');
        const loader = document.getElementById('loader');
        btn.disabled = true; loader.style.display = 'flex';
        
        const data = { 
            userApiKey, 
            city: document.getElementById('city').options[document.getElementById('city').selectedIndex].text, 
            district: document.getElementById('district').value, 
            food: document.getElementById('food').options[document.getElementById('food').selectedIndex].text, 
            purpose: document.getElementById('purpose').options[document.getElementById('purpose').selectedIndex].text, 
            budget: document.getElementById('budget').options[document.getElementById('budget').selectedIndex].text, 
            people: document.getElementById('people').value, 
            mrtStation: document.getElementById('mrt-station').value, 
            filters: (document.getElementById('btn-hidden').classList.contains('selected') ? "éš±è—ç‰ˆ " : "") + (document.getElementById('btn-open').classList.contains('selected') ? "ç‡Ÿæ¥­ä¸­ " : "") 
        };
        
        const res = await getAiRecommendation(data);
        loader.style.display = 'none'; btn.disabled = false;
        
        if(!res.data || res.data.length === 0) { 
            alert("ğŸ” ç›®å‰ç„¡æ³•å–å¾—å»ºè­°ï¼Œè«‹ç¨å¾Œå†è©¦æˆ–æ›´æ› API Keyã€‚"); 
            return; 
        } 
        
        document.getElementById('usage-text').innerText = `ä»Šæ—¥å‰©é¤˜æ¬¡æ•¸ï¼š${res.newRemaining} æ¬¡`;
        renderCards(res.data);
    }

    /* --- 5. å¡ç‰‡èˆ‡å°ç« é‚è¼¯ --- */
    let currentLikedList = []; let swipedCount = 0; let roundCounter = 1;
    
    function renderCards(restaurants) {
        document.getElementById('main-ui').classList.add('blur-mode');
        const stack = document.getElementById('card-stack'); stack.innerHTML = '';
        document.getElementById('swiper-overlay').style.display = 'flex';
        currentLikedList = []; swipedCount = 0;
        document.getElementById('round-info').innerText = roundCounter === 1 ? "å·¦å³æ»‘å‹•ç¯©é¸" : `ç¬¬ ${roundCounter} è¼ªæ±ºé¸`;
        
        restaurants.forEach((res) => {
            const distLabel = calculateDistance(userCoords.lat, userCoords.lng, res.lat, res.lng);
            const wrapper = document.createElement('div'); wrapper.className = 'swipe-card-wrapper';
            const card = document.createElement('div'); card.className = 'swipe-card';
            card.innerHTML = `
                <div class="swipe-label label-like">LIKE</div>
                <div class="swipe-label label-nope">NOPE</div>
                <div class="label-chosen">ğŸ† æœ€çµ‚é¦–é¸</div>
                <h3>${res.name}</h3>
                <div class="card-badges">
                    <span class="card-badge badge-rating">â­ ${res.rating}</span>
                    <span class="card-badge badge-price">ğŸ’° ${res.price}</span>
                    <span class="card-badge badge-distance">ğŸ“ ${distLabel}</span>
                </div>
                <div class="info-row"><span class="info-label">ğŸ•’ ç‡Ÿæ¥­</span><span>${res.hours}</span></div>
                <div class="info-row"><span class="info-label">ğŸ”¥ æ‹›ç‰Œ</span><span>${res.signature}</span></div>
                <div class="card-summary">"${res.review_summary}"</div>
                <a class="card-map-btn" href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(res.map_query || res.name)}" target="_blank">ğŸ” Google åœ°åœ–</a>
            `;
            wrapper.appendChild(card); stack.appendChild(wrapper); initSwipe(card, wrapper, res, restaurants.length);
        });
        stack.scrollTo(0, 0); 
    }

    function initSwipe(el, wrapper, resData, totalInRound) {
        let startX, moveX = 0; let isDone = false;
        el.addEventListener('touchstart', (e) => { if (isDone || e.target.tagName === 'A') return; startX = e.touches[0].clientX; el.style.transition = 'none'; }, {passive: true});
        el.addEventListener('touchmove', (e) => { 
            if (isDone || !startX) return; 
            moveX = e.touches[0].clientX - startX; 
            el.style.transform = `translateX(${moveX}px) rotate(${moveX/20}deg)`; 
            el.querySelector('.label-like').style.opacity = moveX > 0 ? Math.min(moveX/100, 1) : 0; 
            el.querySelector('.label-nope').style.opacity = moveX < 0 ? Math.min(Math.abs(moveX)/100, 1) : 0; 
        }, {passive: false});
        
        el.addEventListener('touchend', () => { 
            if (isDone || !startX) return; el.style.transition = '0.4s ease'; 
            if (Math.abs(moveX) > 100) { 
                const dir = moveX > 0 ? 1 : -1; 
                if (totalInRound === 1 && dir === 1) { 
                    el.style.transform = 'translateX(0)'; el.querySelector('.label-chosen').classList.add('active'); 
                    document.getElementById('round-info').innerText = "ğŸ† æ‚¨çš„æœ€ä½³é¦–é¸"; isDone = true;
                } else { 
                    if (dir === 1) currentLikedList.push(resData); 
                    finishSwipe(el, wrapper, dir, totalInRound); 
                }
            } else { 
                el.style.transform = 'translateX(0) rotate(0deg)'; 
                el.querySelector('.label-like').style.opacity = 0; 
                el.querySelector('.label-nope').style.opacity = 0; 
            } 
            startX = null; 
        });
    }

    function finishSwipe(el, wrapper, dir, totalInRound) { 
        el.style.transform = `translateX(${dir * 150}%)`; el.style.opacity = '0'; 
        setTimeout(() => { 
            wrapper.remove(); swipedCount++; 
            if(swipedCount === totalInRound) { 
                if(currentLikedList.length > 0) { 
                    roundCounter++; renderCards(currentLikedList); 
                } else { 
                    alert("éƒ½æ²’æœ‰å–œæ­¡çš„å—ï¼Ÿé‡æ–°æ¢ç´¢å§ï¼"); resetUI(); 
                } 
            } 
        }, 300); 
    }

    function resetUI() { 
        document.getElementById('swiper-overlay').style.display = 'none'; 
        document.getElementById('main-ui').classList.remove('blur-mode'); 
        roundCounter = 1; 
    }
</script>
